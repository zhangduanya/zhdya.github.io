<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>CMDB模型设计（二） | 拼！就对了！</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="laoqi,laoqi's Blog">
  
  <meta name="description" content="一、创建项目创建Django项目cmdb，配置好settings中的语言和时区，最后新建一个app，名字就叫做assets。这些基本过程以后就不再赘述了，不熟悉的请参考教程的前面部分。 django版本：1.11.11 创建成功后，初始状态如下图所示：  二、模型设计说明：本项目依然采用SQLite数据库，等下一个项目再使用Mysql。 模型设计是整个项目的重中之重，其它所有的内容其实都是围绕它展">
<meta name="keywords" content="django,python,CMDB">
<meta property="og:type" content="article">
<meta property="og:title" content="CMDB模型设计（二）">
<meta property="og:url" content="http://zhdya.okay686.cn/2019/03/01/2、模型设计/index.html">
<meta property="og:site_name" content="拼！就对了！">
<meta property="og:description" content="一、创建项目创建Django项目cmdb，配置好settings中的语言和时区，最后新建一个app，名字就叫做assets。这些基本过程以后就不再赘述了，不熟悉的请参考教程的前面部分。 django版本：1.11.11 创建成功后，初始状态如下图所示：  二、模型设计说明：本项目依然采用SQLite数据库，等下一个项目再使用Mysql。 模型设计是整个项目的重中之重，其它所有的内容其实都是围绕它展">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://myimage.okay686.cn/okay686cn/20190302/FMQqqBKM9bRQ.png?imageslim">
<meta property="og:updated_time" content="2019-04-20T07:00:00.986Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CMDB模型设计（二）">
<meta name="twitter:description" content="一、创建项目创建Django项目cmdb，配置好settings中的语言和时区，最后新建一个app，名字就叫做assets。这些基本过程以后就不再赘述了，不熟悉的请参考教程的前面部分。 django版本：1.11.11 创建成功后，初始状态如下图所示：  二、模型设计说明：本项目依然采用SQLite数据库，等下一个项目再使用Mysql。 模型设计是整个项目的重中之重，其它所有的内容其实都是围绕它展">
<meta name="twitter:image" content="http://myimage.okay686.cn/okay686cn/20190302/FMQqqBKM9bRQ.png?imageslim">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/pace.min.js"></script>
  

  
  

</head>
</html>
<body>
  <div id="container">
      <header id="header">
    <div id="banner"></div>
    <div id="header-outer">
        <div id="header-menu" class="header-menu-pos animated">
            <div class="header-menu-container">
                <a href="/" class="left">
                    <span class="site-title">五谷杂粮，百味人生。</span>
                </a>
                <nav id="header-menu-nav" class="right">
                    
                    <a href="/">
                        <i class="fa fa-home"></i>
                        <span>主页</span>
                    </a>
                    
                    <a href="/archives">
                        <i class="fa fa-archive"></i>
                        <span>归档</span>
                    </a>
                    
                    <a href="/about">
                        <i class="fa fa-user"></i>
                        <span>关于</span>
                    </a>
                    
                </nav>
                <a class="mobile-header-menu-button">
                    <i class="fa fa-bars"></i>
                </a>
            </div>
        </div>
        <div id="header-row">
            <div id="logo">
                <a href="/">
                    <img src="/images/logo.png" alt="logo">
                </a>
            </div>
            <div class="header-info">
                <div id="header-title">
                    
                    <h2>
                        五谷杂粮，百味人生。
                    </h2>
                    
                </div>
                <div id="header-description">
                    
                    <h3>
                        K8S生态，Django，python专列！
                    </h3>
                    
                </div>
            </div>
            <nav class="header-nav">
                <div class="social">
                    
                        <a title="Github" target="_blank" href="//github.com/zhangduanya">
                            <i class="fa fa-github fa-2x"></i></a>
                    
                </div>
            </nav>
        </div>
    </div>
</header>
      <div class="outer">
        <section id="main" class="body-wrap"><article id="post-2、模型设计" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="post-title" itemprop="name">
      CMDB模型设计（二）
    </h1>
    <div class="post-title-bar">
      <ul>
          
              <li>
                  <i class="fa fa-book"></i>
                  
                      <a href="/categories/Python3/">Python3</a>
                  
              </li>
          
        <li>
          <i class="fa fa-calendar"></i>  2019-03-01
        </li>
        <li>
          <i class="fa fa-eye"></i>
          <span id="busuanzi_value_page_pv"></span>
        </li>
      </ul>
    </div>
  

          
      </header>
    
    <div class="article-entry post-content" itemprop="articleBody">
      
            
            <h3 id="一、创建项目"><a href="#一、创建项目" class="headerlink" title="一、创建项目"></a>一、创建项目</h3><p>创建Django项目cmdb，配置好settings中的语言和时区，最后新建一个app，名字就叫做assets。这些基本过程以后就不再赘述了，不熟悉的请参考教程的前面部分。</p>
<pre><code>django版本：1.11.11
</code></pre><p>创建成功后，初始状态如下图所示：</p>
<p><img src="http://myimage.okay686.cn/okay686cn/20190302/FMQqqBKM9bRQ.png?imageslim" alt="mark"></p>
<p>二、模型设计<br>说明：本项目依然采用SQLite数据库，等下一个项目再使用Mysql。</p>
<p>模型设计是整个项目的重中之重，其它所有的内容其实都是围绕它展开的。</p>
<p>而我们设计数据模型的原则和参考依据是前一节分析的项目需求和数据分类表。</p>
<h4 id="1-资产共有数据模型"><a href="#1-资产共有数据模型" class="headerlink" title="1.资产共有数据模型"></a>1.资产共有数据模型</h4><p>打开assets/models.py文件，首先我们要设计一张资产表：</p>
<pre><code>from django.db import models
from django.contrib.auth.models import User

# Create your models here.

class Asset(models.Model):
    &quot;&quot;&quot;    所有资产的共有数据表    &quot;&quot;&quot;
    asset_type_choice = (
        (&#39;server&#39;, &#39;服务器&#39;),
        (&#39;networkdevice&#39;, &#39;网络设备&#39;),
        (&#39;storagedevice&#39;, &#39;存储设备&#39;),
        (&#39;securitydevice&#39;, &#39;安全设备&#39;),
        (&#39;software&#39;, &#39;软件资产&#39;)
    )

    asset_status = (
        (0, &#39;在线&#39;),
        (1, &#39;下线&#39;),
        (2, &#39;未知&#39;),
        (3, &#39;故障&#39;),
        (4, &#39;备用&#39;),
    )

    asset_type = models.CharField(choices=asset_type_choice, max_length=64, default=&#39;server&#39;, verbose_name=&quot;资产类型&quot;)
    name = models.CharField(max_length=64, unique=True, verbose_name=&quot;资产名称&quot;)        ##唯一，不可重复
    sn = models.CharField(max_length=128, unique=True, verbose_name=&quot;资产序列号&quot;)        ##唯一，不可重复
    business_unit = models.ForeignKey(&#39;BusinessUnit&#39;, null=True, blank=True, verbose_name=&quot;所属业务线&quot;)
    status = models.SmallIntegerField(choices=asset_status, default=0, verbose_name=&quot;设备状态&quot;)

    manufacturer = models.ForeignKey(&#39;Manufacturer&#39;, null=True, blank=True, verbose_name=&quot;制造商&quot;)
    manage_ip = models.GenericIPAddressField(null=True, blank=True, verbose_name=&quot;管理IP&quot;)
    tags = models.ManyToManyField(&#39;Tag&#39;, blank=True, verbose_name=&quot;标签&quot;)
    admin = models.ForeignKey(User, null=True, blank=True, verbose_name=&quot;资产管理员&quot;, related_name=&#39;admin&#39;)
    idc = models.ForeignKey(&#39;IDC&#39;, null=True, blank=True, verbose_name=&quot;所在机房&quot;)
    contract = models.ForeignKey(&#39;Contract&#39;, null=True, blank=True, verbose_name=&quot;合同&quot;)

    purchase_day =  models.DateField(null=True, blank=True, verbose_name=&quot;购买日期&quot;)
    expire_day = models.DateField(null=True, blank=True, verbose_name=&quot;过保日期&quot;)
    price = models.FloatField(null=True, blank=True, verbose_name=&quot;价格&quot;)

    approved_by = models.ForeignKey(User, null=True, blank=True, verbose_name=&quot;批准人&quot;, related_name=&quot;approved_by&quot;)

    memo = models.TextField(null=True, blank=True, verbose_name=&quot;备注&quot;)
    c_time = models.DateTimeField(auto_now_add=True, verbose_name=&quot;批准日期&quot;)   ##auto_add_now默认=False：储存当对象被创建时的时间，可以用来存储比如说博客什么时候创建的，后来你再更改博客，它的值也不会变。
    m_time = models.DateTimeField(auto_now=True, verbose_name=&quot;更新日期&quot;)       ##auto_now默认=False:当对象被存储时自动将对象的时间更新为当前时间

    def __str__(self):
        return &#39;&lt;%s&gt;  %s&#39; %(self.get_asset_type_display(), self.name)

    class Meta:
        verbose_name = &quot;资产总表&quot;
        verbose_name_plural = &quot;资产总表&quot;
        ordering = [&#39;-c_time&#39;]
</code></pre><p><strong>说明：</strong></p>
<ul>
<li>sn这个数据字段是所有资产都必须有，并且唯一不可重复的！通常来自自动收集的数据中；</li>
<li>name和sn一样，也是唯一的；</li>
<li>asset_type_choice和asset_status分别设计为两个选择类型</li>
<li>admin和approved_by是分别是当前资产的管理员和将该资产上线的审批员；</li>
<li>导入Django内置的User表，作为我们CMDB项目的用户表，用于保存管理员和审判员等人员信息；</li>
<li>asset表中的很多字段内容都无法自动获取，需要我们手动输入，比如合同、备注。</li>
</ul>
<h4 id="2-服务器模型"><a href="#2-服务器模型" class="headerlink" title="2.服务器模型"></a>2.服务器模型</h4><p>服务器作为资产的一种，而且是最主要的管理对象，包含了一些主要的信息，其模型结构如下：</p>
<pre><code>class Server(models.Model):
    &quot;&quot;&quot;服务器设备&quot;&quot;&quot;
    sub_asset_type_choice = (
        (0, &#39;PC服务器&#39;),
        (1, &#39;刀片型&#39;),
        (2, &#39;小型机&#39;),
    )

    created_by_choice = (
        (&#39;auto&#39;, &#39;自动添加&#39;),
        (&#39;manual&#39;, &#39;手动录入&#39;),
    )

    asset = models.OneToOneField(&#39;Asset&#39;)       # 非常关键的一对一关联！
    sub_asset_type = models.SmallIntegerField(choices=sub_asset_type_choice, default=1, verbose_name=&quot;服务器类型&quot;)
    created_by = models.CharField(choices=created_by_choice, max_length=32, default=&#39;auto&#39;, verbose_name=&quot;添加方式&quot;)
    hosted_on = models.ForeignKey(&#39;self&#39;, related_name=&#39;hosted_on_server&#39;, blank=True, null=True, verbose_name=&quot;宿主机&quot;)       ##虚拟机专用字段
    model = models.CharField(max_length=512, blank=True, null=True, verbose_name=&quot;Raid类型&quot;)

    os_type = models.CharField(&#39;操作系统类型&#39;, max_length=64, blank=True, null=True)
    os_distribution = models.CharField(&#39;发行版本&#39;, max_length=64, blank=True, null=True)
    os_release = models.CharField(&#39;操作系统版本&#39;, max_length=64, blank=True, null=True)

    def __str__(self):
        return &#39;%s--%s--%s &lt;sn:%s&gt;&#39; %(self.asset.name, self.get_sub_asset_type_display(), self.model, self.asset.sn)

    class Meta:
        verbose_name = &#39;服务器&#39;
        verbose_name_plural = &quot;服务器&quot;
</code></pre><p><strong>说明：</strong></p>
<ul>
<li>每台服务器都唯一关联着一个资产对象，因此使用OneToOneField构建了一个一对一字段，这非常重要!</li>
<li>服务器又可分为几种子类型，这里定义了三种；</li>
<li>服务器添加的方式可以分为手动和自动；</li>
<li>有些服务器是虚拟机或者docker生成的，没有物理实体，存在于宿主机中，因此需要增加一个hosted_on字段；</li>
<li>服务器有型号信息，如果硬件信息中不包含，那么指的就是主板型号；</li>
<li>Raid类型在采用了Raid的时候才有，否则为空;</li>
<li>操作系统相关信息包含类型、发行版本和具体版本。</li>
</ul>
<h3 id="3-安全、网络、存储设备和软件资产的模型"><a href="#3-安全、网络、存储设备和软件资产的模型" class="headerlink" title="3.安全、网络、存储设备和软件资产的模型"></a>3.安全、网络、存储设备和软件资产的模型</h3><p>这部分内容不是项目的主要内容，而且数据大多数不能自动收集和报告，很多都需要手工录入。我这里给出了范例，更多的数据字段，可以自行添加。</p>
<pre><code>class SecurityDevice(models.Model):
    &quot;&quot;&quot;安全设备&quot;&quot;&quot;
    sub_asset_type_choice = (
        (0, &#39;防火墙&#39;),
        (1, &#39;入侵检测设备&#39;),
        (2, &#39;互联网网关&#39;),
        (4, &#39;运维审计系统&#39;),
    )

    asset = models.OneToOneField(&#39;Asset&#39;)
    sub_asset_type = models.SmallIntegerField(choices=sub_asset_type_choice, default=0, verbose_name=&quot;安全设备类型&quot;)

    def __str__(self):
        return self.asset.name + &quot;--&quot; + self.get_sub_asset_type_display() + &quot; id:%s&quot; % self.id

    class Meta:
        verbose_name = &#39;安全设备&#39;
        verbose_name_plural = &quot;安全设备&quot;


class StorageDevice(models.Model):
    &quot;&quot;&quot;存储设备&quot;&quot;&quot;
    sub_asset_type_choice = (
        (0, &#39;磁盘阵列&#39;),
        (1, &#39;网络存储器&#39;),
        (2, &#39;磁带库&#39;),
        (4, &#39;磁带机&#39;),
    )

    asset = models.OneToOneField(&#39;Asset&#39;)
    sub_asset_type = models.SmallIntegerField(choices=sub_asset_type_choice, default=0, verbose_name=&quot;存储设备类型&quot;)

    def __str__(self):
        return self.asset.name + &quot;--&quot; + self.get_sub_asset_type_display() + &quot; id:%s&quot; % self.id

    class Meta:
        verbose_name = &#39;存储设备&#39;
        verbose_name_plural = &quot;存储设备&quot;


class NetworkDevice(models.Model):
    &quot;&quot;&quot;网络设备&quot;&quot;&quot;
    sub_asset_type_choice = (
        (0, &#39;路由器&#39;),
        (1, &#39;交换机&#39;),
        (2, &#39;负载均衡&#39;),
        (4, &#39;VPN设备&#39;),
    )

    asset = models.OneToOneField(&#39;Asset&#39;)
    sub_asset_type = models.SmallIntegerField(choices=sub_asset_type_choice, default=0, verbose_name=&quot;网络设备类型&quot;)

    vlan_ip = models.GenericIPAddressField(blank=True, null=True, verbose_name=&quot;VLanIP&quot;)
    intranet_ip = models.GenericIPAddressField(blank=True, null=True, verbose_name=&quot;内网IP&quot;)

    model = models.CharField(max_length=128, null=True, blank=True, verbose_name=&quot;网络设备型号&quot;)
    firmware = models.CharField(max_length=128, blank=True, null=True, verbose_name=&quot;设备固件版本&quot;)
    port_num = models.SmallIntegerField(null=True, blank=True, verbose_name=&quot;端口个数&quot;)
    device_detail = models.TextField(null=True, blank=True, verbose_name=&quot;详细配置&quot;)

    def __str__(self):
        return &#39;%s--%s--%s &lt;sn:%s&gt;&#39; % (self.asset.name, self.get_sub_asset_type_display(), self.model, self.asset.sn)

    class Meta:
        verbose_name = &#39;网络设备&#39;
        verbose_name_plural = &quot;网络设备&quot;


class Software(models.Model):
    &quot;&quot;&quot;
    只保存付费购买的软件
    &quot;&quot;&quot;
    sub_asset_type_choice = (
        (0, &#39;操作系统&#39;),
        (1, &#39;办公\开发软件&#39;),
        (2, &#39;业务软件&#39;),
    )

    sub_asset_type = models.SmallIntegerField(choices=sub_asset_type_choice, default=0, verbose_name=&quot;软件类型&quot;)
    license_num = models.IntegerField(default=1, verbose_name=&quot;授权数量&quot;)
    version = models.CharField(max_length=64, unique=True, help_text=&#39;例如: CentOS release 6.7 (Final)&#39;,
                               verbose_name=&#39;软件/系统版本&#39;)

    def __str__(self):
        return &#39;%s--%s&#39; % (self.get_sub_asset_type_display(), self.version)

    class Meta:
        verbose_name = &#39;软件/系统&#39;
        verbose_name_plural = &quot;软件/系统&quot;
</code></pre><p><strong>说明：</strong></p>
<ul>
<li>每台安全、网络、存储设备都通过一对一的方式唯一关联这一个资产对象。</li>
<li>通过sub_asset_type又细分设备的子类型</li>
<li>对于软件，它没有物理形体，因此无须关联一个资产对象；</li>
<li>软件只管理那些大型的收费软件，关注点是授权数量和软件版本。对于那些开源的或者免费的软件，显然不算公司的资产。</li>
</ul>
<h3 id="4-机房、制造商、业务线、合同、资产标签等数据模型"><a href="#4-机房、制造商、业务线、合同、资产标签等数据模型" class="headerlink" title="4.机房、制造商、业务线、合同、资产标签等数据模型"></a>4.机房、制造商、业务线、合同、资产标签等数据模型</h3><p>这一部分是CMDB中相关的内容，数据表建立后，可以通过手动添加。</p>
<pre><code>class IDC(models.Model):
    &quot;&quot;&quot;机房&quot;&quot;&quot;
    name = models.CharField(max_length=64, unique=True, verbose_name=&quot;机房名称&quot;)
    memo = models.CharField(max_length=128, blank=True, null=True, verbose_name=&#39;备注&#39;)

    def __str__(self):
        return self.name

    class Meta:
        verbose_name = &#39;机房&#39;
        verbose_name_plural = &quot;机房&quot;


class Manufacturer(models.Model):
    &quot;&quot;&quot;厂商&quot;&quot;&quot;

    name = models.CharField(&#39;厂商名称&#39;, max_length=64, unique=True)
    telephone = models.CharField(&#39;支持电话&#39;, max_length=30, blank=True, null=True)
    memo = models.CharField(&#39;备注&#39;, max_length=128, blank=True, null=True)

    def __str__(self):
        return self.name

    class Meta:
        verbose_name = &#39;厂商&#39;
        verbose_name_plural = &quot;厂商&quot;


class BusinessUnit(models.Model):
    &quot;&quot;&quot;业务线&quot;&quot;&quot;

    parent_unit = models.ForeignKey(&#39;self&#39;, blank=True, null=True, related_name=&#39;parent_level&#39;)
    name = models.CharField(&#39;业务线&#39;, max_length=64, unique=True)
    memo = models.CharField(&#39;备注&#39;, max_length=64, blank=True, null=True)

    def __str__(self):
        return self.name

    class Meta:
        verbose_name = &#39;业务线&#39;
        verbose_name_plural = &quot;业务线&quot;


class Contract(models.Model):
    &quot;&quot;&quot;合同&quot;&quot;&quot;

    sn = models.CharField(&#39;合同号&#39;, max_length=128, unique=True)
    name = models.CharField(&#39;合同名称&#39;, max_length=64)
    memo = models.TextField(&#39;备注&#39;, blank=True, null=True)
    price = models.IntegerField(&#39;合同金额&#39;)
    detail = models.TextField(&#39;合同详细&#39;, blank=True, null=True)
    start_day = models.DateField(&#39;开始日期&#39;, blank=True, null=True)
    end_day = models.DateField(&#39;失效日期&#39;, blank=True, null=True)
    license_num = models.IntegerField(&#39;license数量&#39;, blank=True, null=True)
    c_day = models.DateField(&#39;创建日期&#39;, auto_now_add=True)
    m_day = models.DateField(&#39;修改日期&#39;, auto_now=True)

    def __str__(self):
        return self.name

    class Meta:
        verbose_name = &#39;合同&#39;
        verbose_name_plural = &quot;合同&quot;


class Tag(models.Model):
    &quot;&quot;&quot;标签&quot;&quot;&quot;
    name = models.CharField(&#39;标签名&#39;, max_length=32, unique=True)
    c_day = models.DateField(&#39;创建日期&#39;, auto_now_add=True)

    def __str__(self):
        return self.name

    class Meta:
        verbose_name = &#39;标签&#39;
        verbose_name_plural = &quot;标签&quot;
</code></pre><p><strong>说明：</strong></p>
<ul>
<li>机房可以有很多其它字段，比如城市、楼号、楼层和未知等等，如有需要可自行添加；</li>
<li>业务线可以有子业务线，因此使用一个外键关联自身模型；</li>
<li>合同模型主要存储财务部门关心的数据；</li>
<li>资产标签模型与资产是多对多的关系。</li>
</ul>
<h3 id="5-CPU模型"><a href="#5-CPU模型" class="headerlink" title="5.CPU模型"></a>5.CPU模型</h3><p>通常一台服务器中只能有一种CPU型号，所以这里使用OneToOneField唯一关联一个资产对象，而不是外键关系。服务器上可以有多个物理CPU，它们的型号都是一样的。每个物理CPU又可能包含多核。</p>
<pre><code>class CPU(models.Model):
    &quot;&quot;&quot;CPU组件&quot;&quot;&quot;

    asset = models.OneToOneField(&#39;Asset&#39;)  # 设备上的cpu肯定都是一样的，所以不需要建立多个cpu数据，一条就可以，因此使用一对一。
    cpu_model = models.CharField(&#39;CPU型号&#39;, max_length=128, blank=True, null=True)
    cpu_count = models.PositiveSmallIntegerField(&#39;物理CPU个数&#39;, default=1)
    cpu_core_count = models.PositiveSmallIntegerField(&#39;CPU核数&#39;, default=1)

    def __str__(self):
        return self.asset.name + &quot;:   &quot; + self.cpu_model

    class Meta:
        verbose_name = &#39;CPU&#39;
        verbose_name_plural = &quot;CPU&quot;
</code></pre><h3 id="6-RAM模型"><a href="#6-RAM模型" class="headerlink" title="6.RAM模型"></a>6.RAM模型</h3><p>某个资产中可能有多条内存，所以这里必须是外键关系。其次，内存的sn号可能无法获得，就必须通过内存所在的插槽未知来唯一确定每条内存。因此，unique_together = (‘asset’, ‘slot’)这条设置非常关键，相当于内存的主键了，每条内存数据必须包含slot字段，否则就不合法。</p>
<pre><code>class RAM(models.Model):
    &quot;&quot;&quot;内存组件&quot;&quot;&quot;

    asset = models.ForeignKey(&#39;Asset&#39;)  # 只能通过外键关联Asset。否则不能同时关联服务器、网络设备等等。
    sn = models.CharField(&#39;SN号&#39;, max_length=128, blank=True, null=True)
    model = models.CharField(&#39;内存型号&#39;, max_length=128, blank=True, null=True)
    manufacturer = models.CharField(&#39;内存制造商&#39;, max_length=128, blank=True, null=True)
    slot = models.CharField(&#39;插槽&#39;, max_length=64)
    capacity = models.IntegerField(&#39;内存大小(GB)&#39;, blank=True, null=True)

    def __str__(self):
        return &#39;%s: %s: %s: %s&#39; % (self.asset.name, self.model, self.slot, self.capacity)

    class Meta:
        verbose_name = &#39;内存&#39;
        verbose_name_plural = &quot;内存&quot;
        unique_together = (&#39;asset&#39;, &#39;slot&#39;)  #unique_together，也就是联合唯一，同一资产下的内存，根据插槽slot的不同，必须唯一
</code></pre><h3 id="7-硬盘模型"><a href="#7-硬盘模型" class="headerlink" title="7. 硬盘模型"></a>7. 硬盘模型</h3><p>与内存相同的是，硬盘也可能有很多块，所以也是外键关系。不同的是，硬盘通常都能获取到sn号，使用sn作为唯一值比较合适，也就是unique_together = (‘asset’, ‘sn’)。硬盘有不同的接口，这里设置了4种以及unknown，可自行添加其它类别。</p>
<pre><code>class Disk(models.Model):
    &quot;&quot;&quot;存储设备&quot;&quot;&quot;

    disk_interface_type_choice = (
        (&#39;SATA&#39;, &#39;SATA&#39;),
        (&#39;SAS&#39;, &#39;SAS&#39;),
        (&#39;SCSI&#39;, &#39;SCSI&#39;),
        (&#39;SSD&#39;, &#39;SSD&#39;),
        (&#39;unknown&#39;, &#39;unknown&#39;),
    )

    asset = models.ForeignKey(&#39;Asset&#39;)
    sn = models.CharField(&#39;硬盘SN号&#39;, max_length=128)
    slot = models.CharField(&#39;所在插槽位&#39;, max_length=64, blank=True, null=True)
    model = models.CharField(&#39;磁盘型号&#39;, max_length=128, blank=True, null=True)
    manufacturer = models.CharField(&#39;磁盘制造商&#39;, max_length=128, blank=True, null=True)
    capacity = models.FloatField(&#39;磁盘容量(GB)&#39;, blank=True, null=True)
    interface_type = models.CharField(&#39;接口类型&#39;, max_length=16, choices=disk_interface_type_choice, default=&#39;unknown&#39;)

    def __str__(self):
        return &#39;%s:  %s:  %s:  %sGB&#39; % (self.asset.name, self.model, self.slot, self.capacity)

    class Meta:
        verbose_name = &#39;硬盘&#39;
        verbose_name_plural = &quot;硬盘&quot;
        unique_together = (&#39;asset&#39;, &#39;sn&#39;)
</code></pre><h3 id="8-网卡模型"><a href="#8-网卡模型" class="headerlink" title="8.网卡模型"></a>8.网卡模型</h3><p>一台设备中可能有很多块网卡，所以网卡与资产也是外键的关系。另外，由于虚拟机的存在，网卡的mac地址可能会发生重复，无法唯一确定某块网卡，因此通过网卡型号加mac地址的方式来唯一确定网卡。</p>
<pre><code>class NIC(models.Model):
    &quot;&quot;&quot;网卡组件&quot;&quot;&quot;

    asset = models.ForeignKey(&#39;Asset&#39;)  # 注意要用外键
    name = models.CharField(&#39;网卡名称&#39;, max_length=64, blank=True, null=True)
    model = models.CharField(&#39;网卡型号&#39;, max_length=128)
    mac = models.CharField(&#39;MAC地址&#39;, max_length=64)  # 虚拟机有可能会出现同样的mac地址
    ip_address = models.GenericIPAddressField(&#39;IP地址&#39;, blank=True, null=True)
    net_mask = models.CharField(&#39;掩码&#39;, max_length=64, blank=True, null=True)
    bonding = models.CharField(&#39;绑定地址&#39;, max_length=64, blank=True, null=True)

    def __str__(self):
        return &#39;%s:  %s:  %s&#39; % (self.asset.name, self.model, self.mac)

    class Meta:
        verbose_name = &#39;网卡&#39;
        verbose_name_plural = &quot;网卡&quot;
        unique_together = (&#39;asset&#39;, &#39;model&#39;, &#39;mac&#39;)  # 资产、型号和mac必须联合唯一。防止虚拟机中的特殊情况发生错误。
</code></pre><h3 id="9-日志模型"><a href="#9-日志模型" class="headerlink" title="9.日志模型"></a>9.日志模型</h3><p>CMDB必须记录各种日志，这是毫无疑问的！我们通常要记录事件名称、类型、关联的资产、子事件、事件详情、谁导致的、发生时间。这些都很重要！</p>
<p>尤其要注意的是，事件日志不能随着关联资产的删除被一并删除，也就是我们设置on_delete=models.SET_NULL的意义！</p>
<pre><code>class EventLog(models.Model):
    &quot;&quot;&quot;
    日志.
    在关联对象被删除的时候，不能一并删除，需保留日志。
    因此，on_delete=models.SET_NULL
    &quot;&quot;&quot;

    name = models.CharField(&#39;事件名称&#39;, max_length=128)
    event_type_choice = (
        (0, &#39;其它&#39;),
        (1, &#39;硬件变更&#39;),
        (2, &#39;新增配件&#39;),
        (3, &#39;设备下线&#39;),
        (4, &#39;设备上线&#39;),
        (5, &#39;定期维护&#39;),
        (6, &#39;业务上线\更新\变更&#39;),
    )
    asset = models.ForeignKey(&#39;Asset&#39;, blank=True, null=True, on_delete=models.SET_NULL)  # 当资产审批成功时有这项数据
    new_asset = models.ForeignKey(&#39;NewAssetApprovalZone&#39;, blank=True, null=True, on_delete=models.SET_NULL)  # 当资产审批失败时有这项数据
    event_type = models.SmallIntegerField(&#39;事件类型&#39;, choices=event_type_choice, default=4)
    component = models.CharField(&#39;事件子项&#39;, max_length=256, blank=True, null=True)
    detail = models.TextField(&#39;事件详情&#39;)
    date = models.DateTimeField(&#39;事件时间&#39;, auto_now_add=True)
    user = models.ForeignKey(User, blank=True, null=True, verbose_name=&#39;事件执行人&#39;, on_delete=models.SET_NULL)  # 自动更新资产数据时没有执行人
    memo = models.TextField(&#39;备注&#39;, blank=True, null=True)

    def __str__(self):
        return self.name

    class Meta:
        verbose_name = &#39;事件纪录&#39;
        verbose_name_plural = &quot;事件纪录&quot;
</code></pre><h3 id="10-新资产待审批区模型"><a href="#10-新资产待审批区模型" class="headerlink" title="10.新资产待审批区模型"></a>10.新资产待审批区模型</h3><p>新资产的到来，并不能直接加入CMDB数据库中，而是要通过管理员审批后，才可以上线的。这就需要一个新资产的待审批区。在该区中，以资产的sn号作为唯一值，确定不同的资产。除了关键的包含资产所有信息的data字段，为了方便审批员查看信息，我们还设计了一些厂商、型号、内存大小、CPU类型等字段。同时，有可能出现资产还未审批，更新数据就已经发过来的情况，所以需要一个数据更新日期字段。</p>
<pre><code>class NewAssetApprovalZone(models.Model):
    &quot;&quot;&quot;新资产待审批区&quot;&quot;&quot;

    sn = models.CharField(&#39;资产SN号&#39;, max_length=128, unique=True)  # 此字段必填
    asset_type_choice = (
        (&#39;server&#39;, &#39;服务器&#39;),
        (&#39;networkdevice&#39;, &#39;网络设备&#39;),
        (&#39;storagedevice&#39;, &#39;存储设备&#39;),
        (&#39;securitydevice&#39;, &#39;安全设备&#39;),
        (&#39;IDC&#39;, &#39;机房&#39;),
        (&#39;software&#39;, &#39;软件资产&#39;),
    )
    asset_type = models.CharField(choices=asset_type_choice, default=&#39;server&#39;, max_length=64, blank=True, null=True,
                                  verbose_name=&#39;资产类型&#39;)

    manufacturer = models.CharField(max_length=64, blank=True, null=True, verbose_name=&#39;生产厂商&#39;)
    model = models.CharField(max_length=128, blank=True, null=True, verbose_name=&#39;型号&#39;)
    ram_size = models.PositiveIntegerField(blank=True, null=True, verbose_name=&#39;内存大小&#39;)
    cpu_model = models.CharField(max_length=128, blank=True, null=True, verbose_name=&#39;CPU型号&#39;)
    cpu_count = models.PositiveSmallIntegerField(blank=True, null=True)
    cpu_core_count = models.PositiveSmallIntegerField(blank=True, null=True)
    os_distribution = models.CharField(max_length=64, blank=True, null=True)
    os_type = models.CharField(max_length=64, blank=True, null=True)
    os_release = models.CharField(max_length=64, blank=True, null=True)

    data = models.TextField(&#39;资产数据&#39;)  # 此字段必填

    c_time = models.DateTimeField(&#39;汇报日期&#39;, auto_now_add=True)
    m_time = models.DateTimeField(&#39;数据更新日期&#39;, auto_now=True)
    approved = models.BooleanField(&#39;是否批准&#39;, default=False)

    def __str__(self):
        return self.sn

    class Meta:
        verbose_name = &#39;新上线待批准资产&#39;
        verbose_name_plural = &quot;新上线待批准资产&quot;
        ordering = [&#39;-c_time&#39;]
</code></pre><h3 id="11-总结"><a href="#11-总结" class="headerlink" title="11.总结"></a>11.总结</h3><p>通过前面的内容，我们可以看出CMDB数据模型的设计非常复杂，我们这里还是省略了很多不太重要的部分，就这样总共都有400多行代码。其中每个模型需要保存什么字段、采用什么类型、什么关联关系、定义哪些参数、数据是否可以为空，这些都是踩过各种坑后总结出来的，不是随便就能定义的。所以，请务必详细阅读和揣摩这些模型的内容。</p>
<p>一切没有问题之后，注册app，然后makemigrations以及migrate!</p>
<p><strong>注册app：</strong></p>
<p>cmdb/settings.py</p>
<pre><code>INSTALLED_APPS = [
    &#39;django.contrib.admin&#39;,
    &#39;django.contrib.auth&#39;,
    &#39;django.contrib.contenttypes&#39;,
    &#39;django.contrib.sessions&#39;,
    &#39;django.contrib.messages&#39;,
    &#39;django.contrib.staticfiles&#39;,
    &#39;assets&#39;,   ##此处
]
</code></pre><p><strong>创建数据库表单：</strong></p>
<pre><code>python manage.py makemigrations
python manage.py migrate
</code></pre>
            <div class="post-copyright">
    <div class="content">
        <p>最后更新： 2019年04月20日 15:00</p>
        <p>原始链接： <a class="post-url" href="/2019/03/01/2、模型设计/" title="CMDB模型设计（二）">http://zhdya.okay686.cn/2019/03/01/2、模型设计/</a></p>
        <footer>
            <a href="http://zhdya.okay686.cn">
                <img src="/images/logo.png" alt="Zhdya">
                Zhdya
            </a>
        </footer>
    </div>
</div>

      
        
            
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;">赏</a>
</div>

<div id="reward" class="post-modal reward-lay">
    <a class="close" href="javascript:;" id="reward-close">×</a>
    <span class="reward-title">
        <i class="icon icon-quote-left"></i>
        老板，中午饭可否加餐？
        <i class="icon icon-quote-right"></i>
    </span>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/images/wechat_code.jpg" alt="打赏二维码">
        </div>
        <div class="reward-select">
            
            <label class="reward-select-item checked" data-id="wechat" data-wechat="/images/wechat_code.jpg">
                <img class="reward-select-item-wechat" src="/images/wechat.png" alt="微信">
            </label>
            
            
            <label class="reward-select-item" data-id="alipay" data-alipay="/images/alipay_code.jpg">
                <img class="reward-select-item-alipay" src="/images/alipay.png" alt="支付宝">
            </label>
            
        </div>
    </div>
</div>


        
    </div>
    <footer class="article-footer">
        
        
<div class="post-share">
    <a href="javascript:;" id="share-sub" class="post-share-fab">
        <i class="fa fa-share-alt"></i>
    </a>
    <div class="post-share-list" id="share-list">
        <ul class="share-icons">
          <li>
            <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://zhdya.okay686.cn/2019/03/01/2、模型设计/&title=《CMDB模型设计（二）》 — 拼！就对了！&pic=/images/django.jpg" data-title="微博">
              <i class="fa fa-weibo"></i>
            </a>
          </li>
          <li>
            <a class="weixin share-sns" id="wxFab" href="javascript:;" data-title="微信">
              <i class="fa fa-weixin"></i>
            </a>
          </li>
          <li>
            <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://zhdya.okay686.cn/2019/03/01/2、模型设计/&title=《CMDB模型设计（二）》 — 拼！就对了！&source=Tough times never last, but tough people do." data-title="QQ">
              <i class="fa fa-qq"></i>
            </a>
          </li>
          <li>
            <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://zhdya.okay686.cn/2019/03/01/2、模型设计/" data-title="Facebook">
              <i class="fa fa-facebook"></i>
            </a>
          </li>
          <li>
            <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《CMDB模型设计（二）》 — 拼！就对了！&url=http://zhdya.okay686.cn/2019/03/01/2、模型设计/&via=http://zhdya.okay686.cn" data-title="Twitter">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
          <li>
            <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://zhdya.okay686.cn/2019/03/01/2、模型设计/" data-title="Google+">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        </ul>
     </div>
</div>
<div class="post-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;" id="wxShare-close">×</a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=http://zhdya.okay686.cn/2019/03/01/2、模型设计/" alt="微信分享二维码">
</div>

<div class="mask"></div>

        
        <ul class="article-footer-menu">
            
            
  <li class="article-footer-tags">
    <i class="fa fa-tags"></i>
      
    <a href="/tags/django/" class="color2">django</a>
      
    <a href="/tags/python/" class="color2">python</a>
      
    <a href="/tags/CMDB/" class="color5">CMDB</a>
      
  </li>

        </ul>
        
    </footer>
  </div>
</article>


    <aside class="post-toc-pos post-toc-top" id="post-toc">
        <nav class="post-toc-wrap">
            <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#一、创建项目"><span class="post-toc-text">一、创建项目</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-资产共有数据模型"><span class="post-toc-text">1.资产共有数据模型</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-服务器模型"><span class="post-toc-text">2.服务器模型</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-安全、网络、存储设备和软件资产的模型"><span class="post-toc-text">3.安全、网络、存储设备和软件资产的模型</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-机房、制造商、业务线、合同、资产标签等数据模型"><span class="post-toc-text">4.机房、制造商、业务线、合同、资产标签等数据模型</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-CPU模型"><span class="post-toc-text">5.CPU模型</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#6-RAM模型"><span class="post-toc-text">6.RAM模型</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#7-硬盘模型"><span class="post-toc-text">7. 硬盘模型</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#8-网卡模型"><span class="post-toc-text">8.网卡模型</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#9-日志模型"><span class="post-toc-text">9.日志模型</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#10-新资产待审批区模型"><span class="post-toc-text">10.新资产待审批区模型</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#11-总结"><span class="post-toc-text">11.总结</span></a></li></ol>
        </nav>
    </aside>
    

<nav id="article-nav">
  
    <a href="/2019/03/02/3、数据收集客户端/" id="article-nav-newer" class="article-nav-link-wrap">

      <span class="article-nav-title">
        <i class="fa fa-hand-o-left" aria-hidden="true"></i>
        
          CMDB数据收集客户端（三）
        
      </span>
    </a>
  
  
    <a href="/2019/02/28/1、项目需求分析/" id="article-nav-older" class="article-nav-link-wrap">
      <span class="article-nav-title">CMDB项目需求分析（一）</span>
      <i class="fa fa-hand-o-right" aria-hidden="true"></i>
    </a>
  
</nav>



    
        <div id="SOHUCS" sid="2、模型设计"></div>
<script type="text/javascript">
    (function(){
        var appid = 'cyu4TKmA0';
        var conf = '6f0306692caa6c8b75d928a4fc3595c4';
        var width = window.innerWidth || document.documentElement.clientWidth;
        if (width < 960) {
            window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>
    
</section>
        
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info" class="inner">
      
<p>
    <span id="busuanzi_container_site_uv" style="display:none">
        总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style="display:none">
        总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


      <p>
        Powered by  <a href="http://hexo.io/" target="_blank">Hexo</a>
        Theme <a href="//github.com/wongminho/hexo-theme-miho" target="_blank">MiHo</a>
      &copy; 2020 Zhdya<br>
      </p>
    </div>
  </div>
</footer>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script>
  var mihoConfig = {
      root: "http://zhdya.okay686.cn",
      animate: true,
      isHome: false,
      share: true,
      reward: 1
  }
</script>
<div class="sidebar">
    <div id="sidebar-search" title="Search">
        <i class="fa fa-search"></i>
    </div>
    <div id="sidebar-category" title="Categories">
        <i class="fa fa-book"></i>
    </div>
    <div id="sidebar-tag" title="Tags">
        <i class="fa fa-tags"></i>
    </div>
    <div id="sidebar-top">
        <span class="sidebar-top-icon"><i class="fa fa-angle-up"></i></span>
    </div>
</div>
<div class="sidebar-menu-box" id="sidebar-menu-box">
    <div class="sidebar-menu-box-container">
        <div id="sidebar-menu-box-categories">
            <a class="category-link" href="/categories/Django2/">Django2</a><a class="category-link" href="/categories/JAVA/">JAVA</a><a class="category-link" href="/categories/K8S/">K8S</a><a class="category-link" href="/categories/K8s/">K8s</a><a class="category-link" href="/categories/K8s-ceph/">K8s, ceph</a><a class="category-link" href="/categories/Python3/">Python3</a>
        </div>
        <div id="sidebar-menu-box-tags">
            <a href="/tags/BeautifulSoup/" style="font-size: 11.43px;">BeautifulSoup</a> <a href="/tags/CMDB/" style="font-size: 14.29px;">CMDB</a> <a href="/tags/K8S/" style="font-size: 18.57px;">K8S</a> <a href="/tags/Kubernets/" style="font-size: 17.14px;">Kubernets</a> <a href="/tags/calico/" style="font-size: 10px;">calico</a> <a href="/tags/django/" style="font-size: 15.71px;">django</a> <a href="/tags/django2-0/" style="font-size: 12.86px;">django2.0</a> <a href="/tags/django-blog/" style="font-size: 12.86px;">django_blog</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/k8s/" style="font-size: 10px;">k8s</a> <a href="/tags/python/" style="font-size: 20px;">python</a> <a href="/tags/python3/" style="font-size: 11.43px;">python3</a> <a href="/tags/爬虫/" style="font-size: 10px;">爬虫</a>
        </div>
    </div>
    <a href="javascript:;" class="sidebar-menu-box-close">&times;</a>
</div>
<div class="mobile-header-menu-nav" id="mobile-header-menu-nav">
    <div class="mobile-header-menu-container">
        <span class="title">Menus</span>
        <ul class="mobile-header-menu-navbar">
            
            <li>
                <a href="/">
                    <i class="fa fa-home"></i><span>主页</span>
                </a>
            </li>
            
            <li>
                <a href="/archives">
                    <i class="fa fa-archive"></i><span>归档</span>
                </a>
            </li>
            
            <li>
                <a href="/about">
                    <i class="fa fa-user"></i><span>关于</span>
                </a>
            </li>
            
        </ul>
    </div>
    <div class="mobile-header-tag-container">
        <span class="title">Tags</span>
        <div id="mobile-header-container-tags">
            <a href="/tags/BeautifulSoup/" style="font-size: 11.43px;">BeautifulSoup</a> <a href="/tags/CMDB/" style="font-size: 14.29px;">CMDB</a> <a href="/tags/K8S/" style="font-size: 18.57px;">K8S</a> <a href="/tags/Kubernets/" style="font-size: 17.14px;">Kubernets</a> <a href="/tags/calico/" style="font-size: 10px;">calico</a> <a href="/tags/django/" style="font-size: 15.71px;">django</a> <a href="/tags/django2-0/" style="font-size: 12.86px;">django2.0</a> <a href="/tags/django-blog/" style="font-size: 12.86px;">django_blog</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/k8s/" style="font-size: 10px;">k8s</a> <a href="/tags/python/" style="font-size: 20px;">python</a> <a href="/tags/python3/" style="font-size: 11.43px;">python3</a> <a href="/tags/爬虫/" style="font-size: 10px;">爬虫</a>
        </div>
    </div>
</div>
<div class="search-wrap">
    <span class="search-close">&times;</span>
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
            <i class="icon icon-lg icon-chevron-left"></i>
        </a>
        <input class="search-field" placeholder="Search..." id="keywords">
        <a id="search-submit" href="javascript:;">
            <i class="fa fa-search"></i>
        </a>
    <div class="search-container" id="search-container">
        <ul class="search-result" id="search-result">
        </ul>
    </div>
</div>

<div id="search-tpl">
    <li class="search-result-item">
        <a href="{url}" class="search-item-li">
            <span class="search-item-li-title" title="{title}">{title}</span>
        </a>
    </li>
</div>
<script src="/js/search.js"></script>
<script src="/js/main.js"></script>


  <script src="//cdn.bootcss.com/particles.js/2.0.0/particles.min.js"></script>
  <div id="particles"></div>
  <script src="/js/particles.js"></script>







  <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  <script src="//cdn.bootcss.com/scrollReveal.js/3.0.5/scrollreveal.js"></script>
  <script src="/js/animate.js"></script>


  <script src="/js/pop-img.js"></script>
  <script>
     $(".article-entry p img").popImg();
  </script>

  </div>
</body>
</html>