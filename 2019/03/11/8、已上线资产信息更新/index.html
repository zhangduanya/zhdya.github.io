<!DOCTYPE html>
<html lang="zh-CN">





<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="description" content="Tough times never last, but tough people do.">
  <meta name="author" content="Zhdya">
  <meta name="keywords" content="">
  <title>CMDB-已上线资产信息更新（八） ~ 拼！就对了！</title>

  <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/lib/mdbootstrap/css/mdb.min.css">
<link rel="stylesheet" href="/lib/github-markdown/github-markdown.min.css">
<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">


  <link rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css">

<link rel="stylesheet" href="/css/main.css">


  <link rel="stylesheet" href="/lib/fancybox/jquery.fancybox.min.css">


</head>


<body>
  <header style="height: 60vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">&nbsp;<strong>拼！就对了！</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">首页</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">归档</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/categories/">分类</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">标签</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">关于</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background"
         style="background: url('/img/post.jpg')no-repeat center center;
           background-size: cover;
           background-attachment: fixed;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              <br>
              
                <p class="mt-3">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>&nbsp;
                  星期一, 三月 11日 2019, 12:00 凌晨
                </p>
              

              <p>
                
                  
                  &nbsp;<i class="far fa-chart-bar"></i>
                  <span class="post-count">
                    3.5k 字
                  </span>&nbsp;
                

                
                  
                  &nbsp;<i class="far fa-clock"></i>
                  <span class="post-count">
                      16 分钟
                  </span>&nbsp;
                

                
                  <!-- 不蒜子统计文章PV -->
                  
                  &nbsp;<i class="far fa-eye" aria-hidden="true"></i>&nbsp;
                  <span id="busuanzi_container_page_pv">
                    <span id="busuanzi_value_page_pv"></span> 次
                  </span>&nbsp;
                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="py-5 z-depth-3" id="board">
        <div class="post-content mx-auto" id="post">
          <div class="markdown-body">
            <p>前面，我们已经实现了资产进入待审批区、更新待审批区的资产信息以及审批资产上线三个主要功能，还剩下一个最主要的实时更新已上线资产信息的功能。</p>
<p>在assets/views.py中的report视图，目前是把已上线资产的数据更新流程‘pass’了，现在将其替换成下面的语句：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">update_asset = asset_handler.UpdateAsset(request, asset_obj[0], data)</span><br></pre></td></tr></table></figure>
<p><strong>report视图变成了下面的样子：views.py</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">from django.shortcuts import render, HttpResponse</span><br><span class="line">from django.views.decorators.csrf import csrf_exempt</span><br><span class="line">import json</span><br><span class="line">from . import models</span><br><span class="line">from . import asset_handler</span><br><span class="line"></span><br><span class="line"># Create your views here.</span><br><span class="line"></span><br><span class="line">@csrf_exempt</span><br><span class="line">def report(request):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    通过csrf_exempt装饰器，跳过Django的csrf安全机制，让post的数据能被接收，但这又会带来新的安全问题。</span><br><span class="line">    可以在客户端，使用自定义的认证token，进行身份验证。这部分工作，请根据实际情况，自己进行。</span><br><span class="line">    :param request:</span><br><span class="line">    :return:</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    if request.method == &quot;POST&quot;:</span><br><span class="line">        asset_data = request.POST.get(&apos;asset_data&apos;)</span><br><span class="line">        data = json.loads(asset_data)</span><br><span class="line">        # 各种数据检查，请自行添加和完善！</span><br><span class="line">        if not data:</span><br><span class="line">            return HttpResponse(&quot;没有数据！&quot;)</span><br><span class="line">        if not issubclass(dict, type(data)):</span><br><span class="line">            return HttpResponse(&quot;数据必须为字典格式！&quot;)</span><br><span class="line">        # 是否携带了关键的sn号</span><br><span class="line">        sn = data.get(&apos;sn&apos;, None)</span><br><span class="line">        if sn:</span><br><span class="line">            # 进入审批流程</span><br><span class="line">            # 首先判断是否在上线资产中存在该sn</span><br><span class="line">            asset_obj = models.Asset.objects.filter(sn=sn)</span><br><span class="line">            if asset_obj:</span><br><span class="line">                # 进入已上线资产的数据更新流程</span><br><span class="line">                update_asset = asset_handler.UpdateAsset(request, asset_obj[0], data)</span><br><span class="line">                return HttpResponse(&quot;资产数据已经更新！&quot;)</span><br><span class="line">            else:   # 如果已上线资产中没有，那么说明是未批准资产，进入新资产待审批区，更新或者创建资产。</span><br><span class="line">                obj = asset_handler.NewAsset(request, data)</span><br><span class="line">                response = obj.add_to_new_assets_zone()</span><br><span class="line">                return HttpResponse(response)</span><br><span class="line">        else:</span><br><span class="line">            return HttpResponse(&quot;没有资产sn序列号，请检查数据！&quot;)</span><br></pre></td></tr></table></figure>
<p>然后，进入assets/asset_handler.py模块，修改log()方法，增加UpdateAsset类，最终的asset_handler.py如下：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># @Time    : 2019-3-8 07:49</span><br><span class="line"># @Author  : zhdya@zhdya.cn</span><br><span class="line"># @File    : asset_handler.py</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import json</span><br><span class="line">from . import models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class NewAsset(object):</span><br><span class="line">    def __init__(self, request, data):</span><br><span class="line">        self.request = request</span><br><span class="line">        self.data = data</span><br><span class="line">        print(&quot;asset_handler--&gt;&quot;, self.data)</span><br><span class="line"></span><br><span class="line">    def add_to_new_assets_zone(self):</span><br><span class="line">        defaults = &#123;</span><br><span class="line">            &apos;data&apos;: json.dumps(self.data),</span><br><span class="line">            &apos;asset_type&apos;: self.data.get(&apos;asset_type&apos;),</span><br><span class="line">            &apos;manufacturer&apos;: self.data.get(&apos;manufacturer&apos;),</span><br><span class="line">            &apos;model&apos;: self.data.get(&apos;model&apos;),</span><br><span class="line">            &apos;ram_size&apos;: self.data.get(&apos;capacity&apos;),</span><br><span class="line">            &apos;cpu_model&apos;: self.data.get(&apos;cpu_model&apos;),</span><br><span class="line">            &apos;cpu_count&apos;: self.data.get(&apos;cpu_count&apos;),</span><br><span class="line">            &apos;cpu_core_count&apos;: self.data.get(&apos;cpu_core_count&apos;),</span><br><span class="line">            &apos;os_distribution&apos;: self.data.get(&apos;os_distribution&apos;),</span><br><span class="line">            &apos;os_release&apos;: self.data.get(&apos;os_release&apos;),</span><br><span class="line">            &apos;os_type&apos;: self.data.get(&apos;os_type&apos;),</span><br><span class="line">        &#125;</span><br><span class="line">        models.NewAssetApprovalZone.objects.update_or_create(sn=self.data[&apos;sn&apos;], defaults=defaults)</span><br><span class="line">        return &apos;资产已经加入或更新待审批区！&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def log(log_type, msg=None, asset=None, new_asset=None, request=None):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    记录日志，被程序调用</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    event = models.EventLog()</span><br><span class="line">    if log_type == &quot;upline&quot;:</span><br><span class="line">        event.name = &quot;%s &lt;%s&gt; ：  上线&quot; % (asset.name, asset.sn)</span><br><span class="line">        event.asset = asset</span><br><span class="line">        event.detail = &quot;资产成功上线！&quot;</span><br><span class="line">        event.user = request.user</span><br><span class="line">    elif log_type == &quot;approve_failed&quot;:</span><br><span class="line">        event.name = &quot;%s &lt;%s&gt; ：  审批失败&quot; % (new_asset.asset_type, new_asset.sn)</span><br><span class="line">        event.new_asset = new_asset</span><br><span class="line">        event.detail = &quot;审批失败！\n%s&quot; % msg</span><br><span class="line">        event.user = request.user</span><br><span class="line">    elif log_type == &quot;update&quot;:</span><br><span class="line">        event.name = &quot;%s &lt;%s&gt; ：  数据更新！&quot; % (asset.asset_type, asset.sn)</span><br><span class="line">        event.asset = asset</span><br><span class="line">        event.detail = &quot;更新成功！&quot;</span><br><span class="line">    elif log_type == &quot;update_failed&quot;:</span><br><span class="line">        event.name = &quot;%s &lt;%s&gt; ：  更新失败&quot; % (asset.asset_type, asset.sn)</span><br><span class="line">        event.asset = asset</span><br><span class="line">        event.detail = &quot;更新失败！\n%s&quot; % msg</span><br><span class="line">        # 更多日志类型.....</span><br><span class="line">    event.save()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class ApproveAsset:</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    审批资产并上线。</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    def __init__(self, request, asset_id):</span><br><span class="line">        self.request = request</span><br><span class="line">        self.new_asset = models.NewAssetApprovalZone.objects.get(id=asset_id)</span><br><span class="line">        self.data = json.loads(self.new_asset.data)</span><br><span class="line"></span><br><span class="line">    def asset_upline(self):</span><br><span class="line">        # 为以后的其它类型资产扩展留下接口(假如不是server，是firewall 或者其他类型，我们就不需要重复的去写)</span><br><span class="line">        func = getattr(self, &quot;_%s_upline&quot; % self.new_asset.asset_type)</span><br><span class="line">        ret = func()</span><br><span class="line">        return ret and True</span><br><span class="line"></span><br><span class="line">    def _server_upline(self):</span><br><span class="line">        asset = self._create_asset()</span><br><span class="line">        try:</span><br><span class="line">            self._create_manufacturer(asset)  # 创建厂商</span><br><span class="line">            self._create_server(asset)  # 创建服务器</span><br><span class="line">            self._create_CPU(asset)  # 创建CPU</span><br><span class="line">            self._create_RAM(asset)  # 创建内存</span><br><span class="line">            self._create_disk(asset)  # 创建硬盘</span><br><span class="line">            self._create_nic(asset)  # 创建网卡</span><br><span class="line">            self._delete_original_asset()  # 从待审批资产区删除已审批上线的资产</span><br><span class="line">        except Exception as e:</span><br><span class="line">            asset.delete()</span><br><span class="line">            log(&apos;approve_failed&apos;, msg=e, new_asset=self.new_asset, request=self.request)</span><br><span class="line">            print(e)</span><br><span class="line">            return False</span><br><span class="line">        else:</span><br><span class="line">            log(&apos;upline&apos;, asset=asset, request=self.request)</span><br><span class="line">            print(&quot;新服务器上线&quot;)</span><br><span class="line">            return True</span><br><span class="line"></span><br><span class="line">    def _create_asset(self):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        创建资产并上线</span><br><span class="line">        :return:</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        # 利用request.user自动获取当前管理人员的信息，作为审批人添加到资产数据中。</span><br><span class="line">        asset = models.Asset.objects.create(asset_type=self.new_asset.asset_type,</span><br><span class="line">                                            name=&quot;%s: %s&quot; % (self.new_asset.asset_type, self.new_asset.sn),</span><br><span class="line">                                            sn=self.new_asset.sn,</span><br><span class="line">                                            approved_by=self.request.user,</span><br><span class="line">                                            )</span><br><span class="line">        return asset</span><br><span class="line"></span><br><span class="line">    def _create_manufacturer(self, asset):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        创建厂商</span><br><span class="line">        :param asset:</span><br><span class="line">        :return:</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        # 判断厂商数据是否存在。如果存在，看看数据库里是否已经有该厂商，再决定是获取还是创建。</span><br><span class="line">        m = self.new_asset.manufacturer</span><br><span class="line">        if m:</span><br><span class="line">            manufacturer_obj, _ = models.Manufacturer.objects.get_or_create(name=m)</span><br><span class="line">            print(&quot;asset_handler--&gt;create_manufacturer--&gt;&quot;, manufacturer_obj, _)</span><br><span class="line">            asset.manufacturer = manufacturer_obj</span><br><span class="line">            asset.save()</span><br><span class="line"></span><br><span class="line">    def _create_server(self, asset):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        创建服务器</span><br><span class="line">        :param asset:</span><br><span class="line">        :return:</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        models.Server.objects.create(asset=asset,</span><br><span class="line">                                     model=self.new_asset.model,</span><br><span class="line">                                     os_type=self.new_asset.os_type,</span><br><span class="line">                                     os_distribution=self.new_asset.os_distribution,</span><br><span class="line">                                     os_release=self.new_asset.os_release,</span><br><span class="line">                                     )</span><br><span class="line"></span><br><span class="line">    def _create_CPU(self, asset):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        创建CPU.</span><br><span class="line">        教程这里对发送过来的数据采取了最大限度的容忍，</span><br><span class="line">        实际情况下你可能还要对数据的完整性、合法性、数据类型进行检测，</span><br><span class="line">        根据不同的检测情况，是被动接收，还是打回去要求重新收集，请自行决定。</span><br><span class="line">        这里的业务逻辑非常复杂，不可能面面俱到。</span><br><span class="line">        :param asset:</span><br><span class="line">        :return:</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        cpu = models.CPU.objects.create(asset=asset)</span><br><span class="line">        cpu.cpu_model = self.new_asset.cpu_model</span><br><span class="line">        cpu.cpu_count = self.new_asset.cpu_count</span><br><span class="line">        cpu.cpu_core_count = self.new_asset.cpu_core_count</span><br><span class="line">        cpu.save()</span><br><span class="line"></span><br><span class="line">    def _create_RAM(self, asset):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        创建内存。通常有多条内存</span><br><span class="line">        :param asset:</span><br><span class="line">        :return:</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        ram_list = self.data.get(&apos;ram&apos;)</span><br><span class="line">        if not ram_list:    # 万一一条内存数据都没有</span><br><span class="line">            return</span><br><span class="line">        for ram_dict in ram_list:</span><br><span class="line">            if not ram_dict.get(&apos;slot&apos;):</span><br><span class="line">                raise ValueError(&quot;未知的内存插槽！&quot;)  # 使用虚拟机的时候，可能无法获取内存插槽，需要你修改此处的逻辑。</span><br><span class="line">            ram = models.RAM()</span><br><span class="line">            ram.asset = asset</span><br><span class="line">            ram.slot = ram_dict.get(&apos;slot&apos;)</span><br><span class="line">            ram.sn = ram_dict.get(&apos;sn&apos;)</span><br><span class="line">            ram.model = ram_dict.get(&apos;model&apos;)</span><br><span class="line">            ram.manufacturer = ram_dict.get(&apos;manufacturer&apos;)</span><br><span class="line">            ram.capacity = ram_dict.get(&apos;capacity&apos;, 0)</span><br><span class="line">            ram.save()</span><br><span class="line"></span><br><span class="line">    def _create_disk(self, asset):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        存储设备种类多，还有Raid情况，需要根据实际情况具体解决。</span><br><span class="line">        这里只以简单的SATA硬盘为例子。可能有多块硬盘。</span><br><span class="line">        :param asset:</span><br><span class="line">        :return:</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        disk_list = self.data.get(&apos;physical_disk_driver&apos;)</span><br><span class="line">        if not disk_list:  # 一条硬盘数据都没有</span><br><span class="line">            return</span><br><span class="line">        for disk_dict in disk_list:</span><br><span class="line">            if not disk_dict.get(&apos;sn&apos;):</span><br><span class="line">                raise ValueError(&quot;未知sn的硬盘！&quot;)  # 根据sn确定具体某块硬盘。</span><br><span class="line">            disk = models.Disk()</span><br><span class="line">            disk.asset = asset</span><br><span class="line">            disk.sn = disk_dict.get(&apos;sn&apos;)</span><br><span class="line">            disk.model = disk_dict.get(&apos;model&apos;)</span><br><span class="line">            disk.manufacturer = disk_dict.get(&apos;manufacturer&apos;),</span><br><span class="line">            disk.slot = disk_dict.get(&apos;slot&apos;)</span><br><span class="line">            disk.capacity = disk_dict.get(&apos;capacity&apos;, 0)</span><br><span class="line">            iface = disk_dict.get(&apos;iface_type&apos;)</span><br><span class="line">            if iface in [&apos;SATA&apos;, &apos;SAS&apos;, &apos;SCSI&apos;, &apos;SSD&apos;, &apos;unknown&apos;]:</span><br><span class="line">                disk.interface_type = iface</span><br><span class="line">            disk.save()</span><br><span class="line"></span><br><span class="line">    def _create_nic(self, asset):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        创建网卡。可能有多个网卡，甚至虚拟网卡。</span><br><span class="line">        :param asset:</span><br><span class="line">        :return:</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        nic_list = self.data.get(&quot;nic&quot;)</span><br><span class="line">        if not nic_list:</span><br><span class="line">            return</span><br><span class="line"></span><br><span class="line">        for nic_dict in nic_list:</span><br><span class="line">            if not nic_dict.get(&apos;mac&apos;):</span><br><span class="line">                raise ValueError(&quot;网卡缺少mac地址！&quot;)</span><br><span class="line">            if not nic_dict.get(&apos;model&apos;):</span><br><span class="line">                raise ValueError(&quot;网卡型号未知！&quot;)</span><br><span class="line"></span><br><span class="line">            nic = models.NIC()</span><br><span class="line">            nic.asset = asset</span><br><span class="line">            nic.name = nic_dict.get(&apos;name&apos;)</span><br><span class="line">            nic.model = nic_dict.get(&apos;model&apos;)</span><br><span class="line">            nic.mac = nic_dict.get(&apos;mac&apos;)</span><br><span class="line">            nic.ip_address = nic_dict.get(&apos;ip_address&apos;)</span><br><span class="line">            if nic_dict.get(&apos;net_mask&apos;):</span><br><span class="line">                if len(nic_dict.get(&apos;net_mask&apos;)) &gt; 0:</span><br><span class="line">                    nic.net_mask = nic_dict.get(&apos;net_mask&apos;)[0]</span><br><span class="line">            nic.save()</span><br><span class="line"></span><br><span class="line">    def _delete_original_asset(self):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        这里的逻辑是已经审批上线的资产，就从待审批区删除。</span><br><span class="line">        也可以设置为修改成已审批状态但不删除，只是在管理界面特别处理，不让再次审批，灰色显示。</span><br><span class="line">        不过这样可能导致待审批区越来越大。</span><br><span class="line">        :return:</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        self.new_asset.delete()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class UpdateAsset:</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    自动更新已上线的资产。</span><br><span class="line">    如果想让记录的日志更详细，可以逐条对比数据项，将更新过的项目记录到log信息中。</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    def __init__(self, request, asset, report_data):</span><br><span class="line">        self.request = request</span><br><span class="line">        self.asset = asset</span><br><span class="line">        self.report_data = report_data            # 此处的数据是由客户端发送过来的整个数据字符串</span><br><span class="line">        self.asset_update()</span><br><span class="line"></span><br><span class="line">    def asset_update(self):</span><br><span class="line">        # 为以后的其它类型资产扩展留下接口</span><br><span class="line">        func = getattr(self, &quot;_%s_update&quot; % self.report_data[&apos;asset_type&apos;])</span><br><span class="line">        func()</span><br><span class="line"></span><br><span class="line">    def _server_update(self):</span><br><span class="line">        try:</span><br><span class="line">            self._update_manufacturer()   # 更新厂商</span><br><span class="line">            self._update_server()         # 更新服务器</span><br><span class="line">            self._update_CPU()            # 更新CPU</span><br><span class="line">            self._update_RAM()            # 更新内存</span><br><span class="line">            self._update_disk()           # 更新硬盘</span><br><span class="line">            self._update_nic()            # 更新网卡</span><br><span class="line">            self.asset.save()</span><br><span class="line">        except Exception as e:</span><br><span class="line">            log(&apos;update_failed&apos;, msg=e, asset=self.asset, request=self.request)</span><br><span class="line">            print(e)</span><br><span class="line">        else:</span><br><span class="line">            # 添加日志</span><br><span class="line">            log(&quot;update&quot;, asset=self.asset)</span><br><span class="line">            print(&quot;资产数据被更新!&quot;)</span><br><span class="line"></span><br><span class="line">    def _update_manufacturer(self):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        更新厂商</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        m = self.report_data.get(&apos;manufacturer&apos;)</span><br><span class="line">        if m:</span><br><span class="line">            manufacturer_obj, _ = models.Manufacturer.objects.get_or_create(name=m)</span><br><span class="line">            self.asset.manufacturer = manufacturer_obj</span><br><span class="line">        else:</span><br><span class="line">            self.asset.manufacturer = None</span><br><span class="line">        self.asset.manufacturer.save()</span><br><span class="line"></span><br><span class="line">    def _update_server(self):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        更新服务器</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        self.asset.server.model = self.report_data.get(&apos;model&apos;)</span><br><span class="line">        self.asset.server.os_type = self.report_data.get(&apos;os_type&apos;)</span><br><span class="line">        self.asset.server.os_distribution = self.report_data.get(&apos;os_distribution&apos;)</span><br><span class="line">        self.asset.server.os_release = self.report_data.get(&apos;os_release&apos;)</span><br><span class="line">        self.asset.server.save()</span><br><span class="line"></span><br><span class="line">    def _update_CPU(self):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        更新CPU信息</span><br><span class="line">        :return:</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        self.asset.cpu.cpu_model = self.report_data.get(&apos;cpu_model&apos;)</span><br><span class="line">        self.asset.cpu.cpu_count = self.report_data.get(&apos;cpu_count&apos;)</span><br><span class="line">        self.asset.cpu.cpu_core_count = self.report_data.get(&apos;cpu_core_count&apos;)</span><br><span class="line">        self.asset.cpu.save()</span><br><span class="line"></span><br><span class="line">    def _update_RAM(self):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        更新内存信息。</span><br><span class="line">        使用集合数据类型中差的概念，处理不同的情况。</span><br><span class="line">        如果新数据有，但原数据没有，则新增；</span><br><span class="line">        如果新数据没有，但原数据有，则删除原来多余的部分；</span><br><span class="line">        如果新的和原数据都有，则更新。</span><br><span class="line">        在原则上，下面的代码应该写成一个复用的函数，</span><br><span class="line">        但是由于内存、硬盘、网卡在某些方面的差别，导致很难提取出重用的代码。</span><br><span class="line">        :return:</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        # 获取已有内存信息，并转成字典格式</span><br><span class="line">        old_rams = models.RAM.objects.filter(asset=self.asset)</span><br><span class="line">        old_rams_dict = dict()</span><br><span class="line">        if old_rams:</span><br><span class="line">            for ram in old_rams:</span><br><span class="line">                old_rams_dict[ram.slot] = ram</span><br><span class="line">        # 获取新数据中的内存信息，并转成字典格式</span><br><span class="line">        new_rams_list = self.report_data[&apos;ram&apos;]</span><br><span class="line">        new_rams_dict = dict()</span><br><span class="line">        if new_rams_list:</span><br><span class="line">            for item in new_rams_list:</span><br><span class="line">                new_rams_dict[item[&apos;slot&apos;]] = item</span><br><span class="line"></span><br><span class="line">        # 利用set类型的差集功能，获得需要删除的内存数据对象</span><br><span class="line">        need_deleted_keys = set(old_rams_dict.keys()) - set(new_rams_dict.keys())</span><br><span class="line">        if need_deleted_keys:</span><br><span class="line">            for key in need_deleted_keys:</span><br><span class="line">                old_rams_dict[key].delete()</span><br><span class="line"></span><br><span class="line">        # 需要新增或更新的</span><br><span class="line">        if new_rams_dict:</span><br><span class="line">            for key in new_rams_dict:</span><br><span class="line">                defaults = &#123;</span><br><span class="line">                            &apos;sn&apos;: new_rams_dict[key].get(&apos;sn&apos;),</span><br><span class="line">                            &apos;model&apos;: new_rams_dict[key].get(&apos;model&apos;),</span><br><span class="line">                            &apos;manufacturer&apos;: new_rams_dict[key].get(&apos;manufacturer&apos;),</span><br><span class="line">                            &apos;capacity&apos;: new_rams_dict[key].get(&apos;capacity&apos;, 0),</span><br><span class="line">                            &#125;</span><br><span class="line">                models.RAM.objects.update_or_create(asset=self.asset, slot=key, defaults=defaults)</span><br><span class="line"></span><br><span class="line">    def _update_disk(self):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        更新硬盘信息。类似更新内存。</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        old_disks = models.Disk.objects.filter(asset=self.asset)</span><br><span class="line">        old_disks_dict = dict()</span><br><span class="line">        if old_disks:</span><br><span class="line">            for disk in old_disks:</span><br><span class="line">                old_disks_dict[disk.sn] = disk</span><br><span class="line"></span><br><span class="line">        new_disks_list = self.report_data[&apos;physical_disk_driver&apos;]</span><br><span class="line">        new_disks_dict = dict()</span><br><span class="line">        if new_disks_list:</span><br><span class="line">            for item in new_disks_list:</span><br><span class="line">                new_disks_dict[item[&apos;sn&apos;]] = item</span><br><span class="line"></span><br><span class="line">        # 需要删除的</span><br><span class="line">        need_deleted_keys = set(old_disks_dict.keys()) - set(new_disks_dict.keys())</span><br><span class="line">        if need_deleted_keys:</span><br><span class="line">            for key in need_deleted_keys:</span><br><span class="line">                old_disks_dict[key].delete()</span><br><span class="line"></span><br><span class="line">        # 需要新增或更新的</span><br><span class="line">        if new_disks_dict:</span><br><span class="line">            for key in new_disks_dict:</span><br><span class="line">                interface_type = new_disks_dict[key].get(&apos;iface_type&apos;, &apos;unknown&apos;)</span><br><span class="line">                if interface_type not in [&apos;SATA&apos;, &apos;SAS&apos;, &apos;SCSI&apos;, &apos;SSD&apos;, &apos;unknown&apos;]:</span><br><span class="line">                    interface_type = &apos;unknown&apos;</span><br><span class="line">                defaults = &#123;</span><br><span class="line">                    &apos;slot&apos;: new_disks_dict[key].get(&apos;slot&apos;),</span><br><span class="line">                    &apos;model&apos;: new_disks_dict[key].get(&apos;model&apos;),</span><br><span class="line">                    &apos;manufacturer&apos;: new_disks_dict[key].get(&apos;manufacturer&apos;),</span><br><span class="line">                    &apos;capacity&apos;: new_disks_dict[key].get(&apos;capacity&apos;, 0),</span><br><span class="line">                    &apos;interface_type&apos;: interface_type,</span><br><span class="line">                &#125;</span><br><span class="line">                models.Disk.objects.update_or_create(asset=self.asset, sn=key, defaults=defaults)</span><br><span class="line"></span><br><span class="line">    def _update_nic(self):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        更新网卡信息。类似更新内存。</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        old_nics = models.NIC.objects.filter(asset=self.asset)</span><br><span class="line">        old_nics_dict = dict()</span><br><span class="line">        if old_nics:</span><br><span class="line">            for nic in old_nics:</span><br><span class="line">                old_nics_dict[nic.model+nic.mac] = nic</span><br><span class="line"></span><br><span class="line">        new_nics_list = self.report_data[&apos;nic&apos;]</span><br><span class="line">        new_nics_dict = dict()</span><br><span class="line">        if new_nics_list:</span><br><span class="line">            for item in new_nics_list:</span><br><span class="line">                new_nics_dict[item[&apos;model&apos;]+item[&apos;mac&apos;]] = item</span><br><span class="line"></span><br><span class="line">        # 需要删除的</span><br><span class="line">        need_deleted_keys = set(old_nics_dict.keys()) - set(new_nics_dict.keys())</span><br><span class="line">        if need_deleted_keys:</span><br><span class="line">            for key in need_deleted_keys:</span><br><span class="line">                old_nics_dict[key].delete()</span><br><span class="line"></span><br><span class="line">        # 需要新增或更新的</span><br><span class="line">        if new_nics_dict:</span><br><span class="line">            for key in new_nics_dict:</span><br><span class="line">                if new_nics_dict[key].get(&apos;net_mask&apos;) and len(new_nics_dict[key].get(&apos;net_mask&apos;)) &gt; 0:</span><br><span class="line">                    net_mask = new_nics_dict[key].get(&apos;net_mask&apos;)[0]</span><br><span class="line">                else:</span><br><span class="line">                    net_mask = &quot;&quot;</span><br><span class="line">                defaults = &#123;</span><br><span class="line">                    &apos;name&apos;: new_nics_dict[key].get(&apos;name&apos;),</span><br><span class="line">                    &apos;ip_address&apos;: new_nics_dict[key].get(&apos;ip_address&apos;),</span><br><span class="line">                    &apos;net_mask&apos;: net_mask,</span><br><span class="line">                &#125;</span><br><span class="line">                models.NIC.objects.update_or_create(asset=self.asset, model=new_nics_dict[key][&apos;model&apos;],</span><br><span class="line">                                                    mac=new_nics_dict[key][&apos;mac&apos;], defaults=defaults)</span><br><span class="line"></span><br><span class="line">        print(&apos;更新成功！&apos;)</span><br></pre></td></tr></table></figure></p>
<p>对于log()函数，只是增加了两种数据更新的日志类型，分别记录不同的日志情况，没什么特别的。</p>
<p>对于UpdateAsset类，类似前面的ApproveAsset类：</p>
<ul>
<li>首先初始化动作，自动执行asset_update()方法；</li>
<li>依然是通过反射，决定要调用的更新方法；</li>
<li>教程实现了主要的服务器类型资产的更新，对于网络设备、安全设备等请自行完善，基本类似；</li>
<li>_server_update(self)方法中，分别更新厂商、服务器本身、CPU、内存、网卡、硬盘等信息。然后保存数据，这些事务应该是原子性的，所以要抓取异常；</li>
<li>不管成功还是失败，都要记录日志。</li>
</ul>
<p>最主要的，对于_update_CPU(self)等方法，以内存为例，由于内存可能有多条，新的数据中可能出现三种情况，拔除、新增、信息变更，因此要分别对待和处理。</p>
<ul>
<li>首先，获取已有内存信息，并转成字典格式；</li>
<li>其次，获取新数据中的内存信息，并转成字典格式；</li>
<li>利用set类型的差集功能，获得需要删除的内存数据对象</li>
<li>对要删除的对象，执行delete()方法；</li>
<li>对于需要新增或更新的内存对象，首先生成defaults数据字典；</li>
<li>然后，使用update_or_create(asset=self.asset, slot=key, defaults=defaults)方法，一次性完成新增或者更新数据的操作，不用写两个方法的代码；</li>
<li>硬盘和网卡的操作类同内存的操作。</li>
</ul>
<p>数据更新完毕后，需要保存asset对象，也就是self.asset.save()，否则前面的工作无法关联保存下来。</p>
<p>现在，可以测试一下资产数据的更新了。重启CMDB，然后转到Client/report_assetss.py脚本，直接运行：</p>
<p><img src="http://myimage.okay686.cn/okay686cn/20190322/rzEAKlYGx2Vk.png?imageslim" srcset="/img/loading.gif" alt="mark"></p>
<p>修改其中的一些数据，删除或增加一些内存、硬盘、网卡的条目。<strong>注意数据格式必须正确，sn必须不能变。</strong></p>
<p>再次运行脚本，报告数据。进入admin中查看相关内容，可以看到数据已经得到更新了。</p>
<p>至此，CMDB自动资产管理系统的后台部分已经完成了。</p>

            <hr>
          </div>
          <br>
          <div>
            <p>
            
              <span>
                <i class="iconfont icon-inbox"></i>
                
                  <a class="hover-with-bg" href="/categories/Python3">Python3</a>
                  &nbsp;
                
              </span>&nbsp;&nbsp;
            
            
              <span>
                <i class="iconfont icon-tag"></i>
                
                  <a class="hover-with-bg" href="/tags/django">django</a>
                
                  <a class="hover-with-bg" href="/tags/python">python</a>
                
                  <a class="hover-with-bg" href="/tags/CMDB">CMDB</a>
                
              </span>
            
            </p>
            
              <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" rel="nofollow noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
            
          </div>
        </div>
      </div>
    </div>
    <div class="d-none d-lg-block col-lg-2 toc-container">
      
  <div id="toc">
    <p class="h4"><i class="far fa-list-alt"></i>&nbsp;目录</p>
    <div id="tocbot"></div>
  </div>

    </div>
  </div>
</div>

<!-- custom -->


<!-- Comments -->
<div class="col-lg-7 mx-auto nopadding-md">
  <div class="container comments mx-auto" id="comments">
    
  </div>
</div>

    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  <footer class="mt-5">
  <div class="text-center py-3">
    <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Hexo</b></a>
    <i class="iconfont icon-love"></i>
    <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"> <b>Fluid</b></a>
    <br>

    
  
    <!-- 不蒜子统计PV -->
    
    &nbsp;<span id="busuanzi_container_site_pv">总访问量 
          <span id="busuanzi_value_site_pv"></span> 次</span>&nbsp;
  
  
    <!-- 不蒜子统计UV -->
    
    &nbsp;<span id="busuanzi_container_site_uv">总访客数 
            <span id="busuanzi_value_site_uv"></span> 人</span>&nbsp;
  
  <br>



    
  <!-- 备案信息 -->
  <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">苏ICP备16041225号-2</a>
  



    <!-- cnzz Analytics icon -->
    

  </div>
</footer>

<!-- SCRIPTS -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/popper/popper.min.js"></script>
<script src="/lib/bootstrap/js/bootstrap.min.js"></script>
<script src="/lib/mdbootstrap/js/mdb.min.js"></script>
<script src="/js/main.js"></script>


  <script src="/js/lazyload.js"></script>



  
    <script src="/lib/tocbot/tocbot.min.js"></script>
  
  <script src="/js/post.js"></script>



  <script src="/lib/smooth-scroll/smooth-scroll.min.js"></script>



  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<!-- Plugins -->


  

  

  

  

  <!-- cnzz Analytics -->
  



  <script src="/lib/prettify/prettify.min.js"></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  ');
      prettyPrint();
    })
  </script>



  <script src="/lib/typed/typed.min.js"></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "CMDB-已上线资产信息更新（八）&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 50,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script src="/lib/anchor/anchor.min.js"></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "false",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script src="/js/local-search.js"></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script src="/lib/fancybox/jquery.fancybox.min.js"></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>





  
  
    <script>
      !function (e, t, a) {
        function r() {
          for (var e = 0; e < s.length; e++) s[e].alpha <= 0 ? (t.body.removeChild(s[e].el), s.splice(e, 1)) : (s[e].y--, s[e].scale += .004, s[e].alpha -= .013, s[e].el.style.cssText = "left:" + s[e].x + "px;top:" + s[e].y + "px;opacity:" + s[e].alpha + ";transform:scale(" + s[e].scale + "," + s[e].scale + ") rotate(45deg);background:" + s[e].color + ";z-index:99999");
          requestAnimationFrame(r)
        }

        function n() {
          var t = "function" == typeof e.onclick && e.onclick;
          e.onclick = function (e) {
            t && t(), o(e)
          }
        }

        function o(e) {
          var a = t.createElement("div");
          a.className = "heart", s.push({
            el: a,
            x: e.clientX - 5,
            y: e.clientY - 5,
            scale: 1,
            alpha: 1,
            color: c()
          }), t.body.appendChild(a)
        }

        function i(e) {
          var a = t.createElement("style");
          a.type = "text/css";
          try {
            a.appendChild(t.createTextNode(e))
          } catch (t) {
            a.styleSheet.cssText = e
          }
          t.getElementsByTagName("head")[0].appendChild(a)
        }

        function c() {
          return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
        }

        var s = [];
        e.requestAnimationFrame = e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.oRequestAnimationFrame || e.msRequestAnimationFrame || function (e) {
          setTimeout(e, 1e3 / 60)
        }, i(".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}"), n(), r()
      }(window, document);
    </script>
  







</body>
</html>
