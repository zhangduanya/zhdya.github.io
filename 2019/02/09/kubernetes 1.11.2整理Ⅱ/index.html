<!DOCTYPE html>
<html lang="zh-CN">





<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="description" content="Tough times never last, but tough people do.">
  <meta name="author" content="Zhdya">
  <meta name="keywords" content="">
  <title>kubernetes 1.11.2整理Ⅱ ~ 拼！就对了！</title>

  <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/lib/mdbootstrap/css/mdb.min.css">
<link rel="stylesheet" href="/lib/github-markdown/github-markdown.min.css">
<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">


  <link rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css">

<link rel="stylesheet" href="/css/main.css">


  <link rel="stylesheet" href="/lib/fancybox/jquery.fancybox.min.css">


</head>


<body>
  <header style="height: 60vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">&nbsp;<strong>拼！就对了！</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">首页</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">归档</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/categories/">分类</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">标签</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">关于</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background"
         style="background: url('/img/post.jpg')no-repeat center center;
           background-size: cover;
           background-attachment: fixed;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              <br>
              
                <p class="mt-3">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>&nbsp;
                  星期六, 二月 9日 2019, 12:00 凌晨
                </p>
              

              <p>
                
                  
                  &nbsp;<i class="far fa-chart-bar"></i>
                  <span class="post-count">
                    4k 字
                  </span>&nbsp;
                

                
                  
                  &nbsp;<i class="far fa-clock"></i>
                  <span class="post-count">
                      21 分钟
                  </span>&nbsp;
                

                
                  <!-- 不蒜子统计文章PV -->
                  
                  &nbsp;<i class="far fa-eye" aria-hidden="true"></i>&nbsp;
                  <span id="busuanzi_container_page_pv">
                    <span id="busuanzi_value_page_pv"></span> 次
                  </span>&nbsp;
                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="py-5 z-depth-3" id="board">
        <div class="post-content mx-auto" id="post">
          <div class="markdown-body">
            <h3 id="配置-kubelet-认证"><a href="#配置-kubelet-认证" class="headerlink" title="配置 kubelet 认证"></a>配置 kubelet 认证</h3><p>kubelet 授权 kube-apiserver 的一些操作 exec run logs 等</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># RBAC 只需创建一次就可以</span><br><span class="line"></span><br><span class="line">kubectl create clusterrolebinding kube-apiserver:kubelet-apis --clusterrole=system:kubelet-api-admin --user kubernetes</span><br></pre></td></tr></table></figure>
<h4 id="创建-bootstrap-kubeconfig-文件"><a href="#创建-bootstrap-kubeconfig-文件" class="headerlink" title="创建 bootstrap kubeconfig 文件"></a>创建 bootstrap kubeconfig 文件</h4><p>++注意: token 生效时间为 1day , 超过时间未创建自动失效，需要重新创建 token++</p>
<h4 id="创建-集群所有-kubelet-的-token"><a href="#创建-集群所有-kubelet-的-token" class="headerlink" title="创建 集群所有 kubelet 的 token"></a>创建 集群所有 kubelet 的 token</h4><p>==注意修改hostname==<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@master1 kubernetes]# kubeadm token create --description kubelet-bootstrap-token --groups system:bootstrappers:master1 --kubeconfig ~/.kube/config</span><br><span class="line">of2phx.v39lq3ofeh0w6f3m</span><br><span class="line"></span><br><span class="line">[root@master1 kubernetes]# kubeadm token create --description kubelet-bootstrap-token --groups system:bootstrappers:master2 --kubeconfig ~/.kube/config</span><br><span class="line">b3stk9.edz2iylppqjo5qbc</span><br><span class="line"></span><br><span class="line">[root@master1 kubernetes]# kubeadm token create --description kubelet-bootstrap-token --groups system:bootstrappers:master3 --kubeconfig ~/.kube/config</span><br><span class="line">ck2uqr.upeu75jzjj1ko901</span><br><span class="line"></span><br><span class="line">[root@master1 kubernetes]# kubeadm token create --description kubelet-bootstrap-token --groups system:bootstrappers:node1 --kubeconfig ~/.kube/config</span><br><span class="line">1ocjm9.7qa3rd5byuft9gwr</span><br><span class="line"></span><br><span class="line">[root@master1 kubernetes]# kubeadm token create --description kubelet-bootstrap-token --groups system:bootstrappers:node2 --kubeconfig ~/.kube/config</span><br><span class="line">htsqn3.z9z6579gxw5jdfzd</span><br></pre></td></tr></table></figure></p>
<h4 id="查看生成的-token"><a href="#查看生成的-token" class="headerlink" title="查看生成的 token"></a>查看生成的 token</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@master1 kubernetes]# kubeadm token list --kubeconfig ~/.kube/config</span><br><span class="line">TOKEN                     TTL       EXPIRES                     USAGES                   DESCRIPTION               EXTRA GROUPS</span><br><span class="line">1ocjm9.7qa3rd5byuft9gwr   23h       2018-09-02T16:06:32+08:00   authentication,signing   kubelet-bootstrap-token   system:bootstrappers:node1</span><br><span class="line"></span><br><span class="line">b3stk9.edz2iylppqjo5qbc   23h       2018-09-02T16:03:46+08:00   authentication,signing   kubelet-bootstrap-token   system:bootstrappers:master2</span><br><span class="line"></span><br><span class="line">ck2uqr.upeu75jzjj1ko901   23h       2018-09-02T16:05:16+08:00   authentication,signing   kubelet-bootstrap-token   system:bootstrappers:master3</span><br><span class="line"></span><br><span class="line">htsqn3.z9z6579gxw5jdfzd   23h       2018-09-02T16:06:34+08:00   authentication,signing   kubelet-bootstrap-token   system:bootstrappers:node2</span><br><span class="line"></span><br><span class="line">of2phx.v39lq3ofeh0w6f3m   23h       2018-09-02T16:03:40+08:00   authentication,signing   kubelet-bootstrap-token   system:bootstrappers:master1</span><br></pre></td></tr></table></figure>
<p>以下为了区分 会先生成 hostname 名称加 bootstrap.kubeconfig</p>
<h4 id="生成-master1-的-bootstrap-kubeconfig"><a href="#生成-master1-的-bootstrap-kubeconfig" class="headerlink" title="生成 master1 的 bootstrap.kubeconfig"></a>生成 master1 的 bootstrap.kubeconfig</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 配置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=https://127.0.0.1:6443 \</span><br><span class="line">  --kubeconfig=master1-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"># 配置客户端认证</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials kubelet-bootstrap \</span><br><span class="line">  --token=of2phx.v39lq3ofeh0w6f3m \</span><br><span class="line">  --kubeconfig=master1-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 配置关联</span><br><span class="line"></span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kubelet-bootstrap \</span><br><span class="line">  --kubeconfig=master1-bootstrap.kubeconfig</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"># 配置默认关联</span><br><span class="line">kubectl config use-context default --kubeconfig=master1-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"># 拷贝生成的 master1-bootstrap.kubeconfig 文件</span><br><span class="line"></span><br><span class="line">mv master1-bootstrap.kubeconfig /etc/kubernetes/bootstrap.kubeconfig</span><br></pre></td></tr></table></figure>
<h4 id="生成-master2-的-bootstrap-kubeconfig"><a href="#生成-master2-的-bootstrap-kubeconfig" class="headerlink" title="生成 master2 的 bootstrap.kubeconfig"></a>生成 master2 的 bootstrap.kubeconfig</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 配置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=https://127.0.0.1:6443 \</span><br><span class="line">  --kubeconfig=master2-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"># 配置客户端认证</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials kubelet-bootstrap \</span><br><span class="line">  --token=b3stk9.edz2iylppqjo5qbc \</span><br><span class="line">  --kubeconfig=master2-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 配置关联</span><br><span class="line"></span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kubelet-bootstrap \</span><br><span class="line">  --kubeconfig=master2-bootstrap.kubeconfig</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"># 配置默认关联</span><br><span class="line">kubectl config use-context default --kubeconfig=master2-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 拷贝生成的 master2-bootstrap.kubeconfig 文件</span><br><span class="line"></span><br><span class="line">scp master2-bootstrap.kubeconfig 192.168.161.162:/etc/kubernetes/bootstrap.kubeconfig</span><br></pre></td></tr></table></figure>
<h4 id="生成-master3-的-bootstrap-kubeconfig"><a href="#生成-master3-的-bootstrap-kubeconfig" class="headerlink" title="生成 master3 的 bootstrap.kubeconfig"></a>生成 master3 的 bootstrap.kubeconfig</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 配置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=https://127.0.0.1:6443 \</span><br><span class="line">  --kubeconfig=master3-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"># 配置客户端认证</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials kubelet-bootstrap \</span><br><span class="line">  --token=ck2uqr.upeu75jzjj1ko901 \</span><br><span class="line">  --kubeconfig=master3-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 配置关联</span><br><span class="line"></span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kubelet-bootstrap \</span><br><span class="line">  --kubeconfig=master3-bootstrap.kubeconfig</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"># 配置默认关联</span><br><span class="line">kubectl config use-context default --kubeconfig=master3-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 拷贝生成的 master3-bootstrap.kubeconfig 文件</span><br><span class="line"></span><br><span class="line">scp master3-bootstrap.kubeconfig 192.168.161.163:/etc/kubernetes/bootstrap.kubeconfig</span><br></pre></td></tr></table></figure>
<h4 id="生成-node1-的-bootstrap-kubeconfig"><a href="#生成-node1-的-bootstrap-kubeconfig" class="headerlink" title="生成 node1 的 bootstrap.kubeconfig"></a>生成 node1 的 bootstrap.kubeconfig</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 配置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=https://127.0.0.1:6443 \</span><br><span class="line">  --kubeconfig=node1-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"># 配置客户端认证</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials kubelet-bootstrap \</span><br><span class="line">  --token=1ocjm9.7qa3rd5byuft9gwr \</span><br><span class="line">  --kubeconfig=node1-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 配置关联</span><br><span class="line"></span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kubelet-bootstrap \</span><br><span class="line">  --kubeconfig=node1-bootstrap.kubeconfig</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"># 配置默认关联</span><br><span class="line">kubectl config use-context default --kubeconfig=node1-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 拷贝生成的 node1-bootstrap.kubeconfig 文件</span><br><span class="line"></span><br><span class="line">scp node1-bootstrap.kubeconfig 192.168.161.77:/etc/kubernetes/bootstrap.kubeconfig</span><br></pre></td></tr></table></figure>
<h4 id="生成-node2-的-bootstrap-kubeconfig"><a href="#生成-node2-的-bootstrap-kubeconfig" class="headerlink" title="生成 node2 的 bootstrap.kubeconfig"></a>生成 node2 的 bootstrap.kubeconfig</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 配置集群参数</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=https://127.0.0.1:6443 \</span><br><span class="line">  --kubeconfig=node2-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"># 配置客户端认证</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials kubelet-bootstrap \</span><br><span class="line">  --token=htsqn3.z9z6579gxw5jdfzd \</span><br><span class="line">  --kubeconfig=node2-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 配置关联</span><br><span class="line"></span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kubelet-bootstrap \</span><br><span class="line">  --kubeconfig=node2-bootstrap.kubeconfig</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"># 配置默认关联</span><br><span class="line">kubectl config use-context default --kubeconfig=node2-bootstrap.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 拷贝生成的 node2-bootstrap.kubeconfig 文件</span><br><span class="line"></span><br><span class="line">scp node2-bootstrap.kubeconfig 192.168.161.78:/etc/kubernetes/bootstrap.kubeconfig</span><br></pre></td></tr></table></figure>
<h3 id="配置-bootstrap-RBAC-权限"><a href="#配置-bootstrap-RBAC-权限" class="headerlink" title="配置 bootstrap RBAC 权限"></a>配置 bootstrap RBAC 权限</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --group=system:bootstrappers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 否则报如下错误</span><br><span class="line"></span><br><span class="line">failed to run Kubelet: cannot create certificate signing request: certificatesigningrequests.certificates.k8s.io is forbidden: User &quot;system:bootstrap:1jezb7&quot; cannot create certificatesigningrequests.certificates.k8s.io at the cluster scope</span><br></pre></td></tr></table></figure>
<h4 id="创建自动批准相关-CSR-请求的-ClusterRole"><a href="#创建自动批准相关-CSR-请求的-ClusterRole" class="headerlink" title="创建自动批准相关 CSR 请求的 ClusterRole"></a>创建自动批准相关 CSR 请求的 ClusterRole</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi /etc/kubernetes/tls-instructs-csr.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kind: ClusterRole</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  name: system:certificates.k8s.io:certificatesigningrequests:selfnodeserver</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;certificates.k8s.io&quot;]</span><br><span class="line">  resources: [&quot;certificatesigningrequests/selfnodeserver&quot;]</span><br><span class="line">  verbs: [&quot;create&quot;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 创建 yaml 文件</span><br><span class="line">[root@master1 kubernetes]# kubectl apply -f /etc/kubernetes/tls-instructs-csr.yaml</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:certificates.k8s.io:certificatesigningrequests:selfnodeserver created</span><br><span class="line"></span><br><span class="line">[root@master1 kubernetes]# kubectl describe ClusterRole/system:certificates.k8s.io:certificatesigningrequests:selfnodeserver</span><br><span class="line">Name:         system:certificates.k8s.io:certificatesigningrequests:selfnodeserver</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubectl.kubernetes.io/last-applied-configuration=&#123;&quot;apiVersion&quot;:&quot;rbac.authorization.k8s.io/v1&quot;,&quot;kind&quot;:&quot;ClusterRole&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;system:certificates.k8s.io:certificatesigningreq...</span><br><span class="line">PolicyRule:</span><br><span class="line">  Resources                                                      Non-Resource URLs  Resource Names  Verbs</span><br><span class="line">  ---------                                                      -----------------  --------------  -----</span><br><span class="line">  certificatesigningrequests.certificates.k8s.io/selfnodeserver  []                 []              [create]</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#  将 ClusterRole 绑定到适当的用户组</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 自动批准 system:bootstrappers 组用户 TLS bootstrapping 首次申请证书的 CSR 请求</span><br><span class="line"></span><br><span class="line">kubectl create clusterrolebinding node-client-auto-approve-csr --clusterrole=system:certificates.k8s.io:certificatesigningrequests:nodeclient --group=system:bootstrappers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 自动批准 system:nodes 组用户更新 kubelet 自身与 apiserver 通讯证书的 CSR 请求</span><br><span class="line"></span><br><span class="line">kubectl create clusterrolebinding node-client-auto-renew-crt --clusterrole=system:certificates.k8s.io:certificatesigningrequests:selfnodeclient --group=system:nodes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 自动批准 system:nodes 组用户更新 kubelet 10250 api 端口证书的 CSR 请求</span><br><span class="line"></span><br><span class="line">kubectl create clusterrolebinding node-server-auto-renew-crt --clusterrole=system:certificates.k8s.io:certificatesigningrequests:selfnodeserver --group=system:nodes</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="Node-端"><a href="#Node-端" class="headerlink" title="Node 端"></a>Node 端</h2><p>单 Node 部分 需要部署的组件有<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker， calico， kubelet， kube-proxy</span><br></pre></td></tr></table></figure></p>
<p>这几个组件。 Node 节点 基于 Nginx 负载 API 做 Master HA</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># master 之间除 api server 以外其他组件通过 etcd 选举，api server 默认不作处理；</span><br><span class="line"></span><br><span class="line">在每个 node 上启动一个 nginx，每个 nginx 反向代理所有 api server;</span><br><span class="line"></span><br><span class="line">node 上 kubelet、kube-proxy 连接本地的 nginx 代理端口;</span><br><span class="line"></span><br><span class="line">当 nginx 发现无法连接后端时会自动踢掉出问题的 api server，从而实现 api server 的 HA;</span><br></pre></td></tr></table></figure>
<p><img src="http://myimage.okay686.cn/okay686cn/180901/d4da31h4lB.jpg?imageslim" srcset="/img/loading.gif" alt="mark"></p>
<p>++这种模式和我之前所接触的不太一样，之前所做的架构是基于KUBE-APISERVER 的负载均衡，所有的node节点都会去连接负载均衡的虚拟VIP。++</p>
<h3 id="创建Nginx-代理"><a href="#创建Nginx-代理" class="headerlink" title="创建Nginx 代理"></a>创建Nginx 代理</h3><p>在每个 node 都必须创建一个 Nginx 代理， 这里特别注意， 当 Master 也做为 Node 的时候 不需要配置 Nginx-proxy</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 创建配置目录</span><br><span class="line">mkdir -p /etc/nginx</span><br><span class="line"></span><br><span class="line"># 写入代理配置</span><br><span class="line">cat &lt;&lt; EOF &gt;&gt; /etc/nginx/nginx.conf</span><br><span class="line">error_log stderr notice;</span><br><span class="line"></span><br><span class="line">worker_processes auto;</span><br><span class="line">events &#123;</span><br><span class="line">  multi_accept on;</span><br><span class="line">  use epoll;</span><br><span class="line">  worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stream &#123;</span><br><span class="line">    upstream kube_apiserver &#123;</span><br><span class="line">        least_conn;</span><br><span class="line">        server 192.168.161.161:6443;</span><br><span class="line">        server 192.168.161.162:6443;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen        0.0.0.0:6443;</span><br><span class="line">        proxy_pass    kube_apiserver;</span><br><span class="line">        proxy_timeout 10m;</span><br><span class="line">        proxy_connect_timeout 1s;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 更新权限</span><br><span class="line">chmod +r /etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 配置 Nginx 基于 docker 进程，然后配置 systemd 来启动</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt;&gt; /etc/systemd/system/nginx-proxy.service</span><br><span class="line">[Unit]</span><br><span class="line">Description=kubernetes apiserver docker wrapper</span><br><span class="line">Wants=docker.socket</span><br><span class="line">After=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=root</span><br><span class="line">PermissionsStartOnly=true</span><br><span class="line">ExecStart=/usr/bin/docker run -p 127.0.0.1:6443:6443 \\</span><br><span class="line">                              -v /etc/nginx:/etc/nginx \\</span><br><span class="line">                              --name nginx-proxy \\</span><br><span class="line">                              --net=host \\</span><br><span class="line">                              --restart=on-failure:5 \\</span><br><span class="line">                              --memory=512M \\</span><br><span class="line">                              nginx:1.13.7-alpine</span><br><span class="line">ExecStartPre=-/usr/bin/docker rm -f nginx-proxy</span><br><span class="line">ExecStop=/usr/bin/docker stop nginx-proxy</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=15s</span><br><span class="line">TimeoutStartSec=30s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h4 id="启动-Nginx"><a href="#启动-Nginx" class="headerlink" title="启动 Nginx"></a>启动 Nginx</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start nginx-proxy</span><br><span class="line">systemctl enable nginx-proxy</span><br><span class="line">systemctl status nginx-proxy</span><br><span class="line"></span><br><span class="line">journalctl  -u nginx-proxy -f   ##查看实时日志</span><br><span class="line"></span><br><span class="line">9月 01 17:34:55 node1 docker[4032]: 1.13.7-alpine: Pulling from library/nginx</span><br><span class="line">9月 01 17:34:57 node1 docker[4032]: 128191993b8a: Pulling fs layer</span><br><span class="line">9月 01 17:34:57 node1 docker[4032]: 655cae3ea06e: Pulling fs layer</span><br><span class="line">9月 01 17:34:57 node1 docker[4032]: dbc72c3fd216: Pulling fs layer</span><br><span class="line">9月 01 17:34:57 node1 docker[4032]: f391a4589e37: Pulling fs layer</span><br><span class="line">9月 01 17:34:57 node1 docker[4032]: f391a4589e37: Waiting</span><br><span class="line">9月 01 17:35:03 node1 docker[4032]: dbc72c3fd216: Verifying Checksum</span><br><span class="line">9月 01 17:35:03 node1 docker[4032]: dbc72c3fd216: Download complete</span><br><span class="line">9月 01 17:35:07 node1 docker[4032]: f391a4589e37: Verifying Checksum</span><br><span class="line">9月 01 17:35:07 node1 docker[4032]: f391a4589e37: Download complete</span><br><span class="line">9月 01 17:35:15 node1 docker[4032]: 128191993b8a: Verifying Checksum</span><br><span class="line">9月 01 17:35:15 node1 docker[4032]: 128191993b8a: Download complete</span><br><span class="line">9月 01 17:35:17 node1 docker[4032]: 128191993b8a: Pull complete</span><br><span class="line">9月 01 17:35:50 node1 docker[4032]: 655cae3ea06e: Verifying Checksum</span><br><span class="line">9月 01 17:35:50 node1 docker[4032]: 655cae3ea06e: Download complete</span><br><span class="line">9月 01 17:35:51 node1 docker[4032]: 655cae3ea06e: Pull complete</span><br><span class="line">9月 01 17:35:51 node1 docker[4032]: dbc72c3fd216: Pull complete</span><br><span class="line">9月 01 17:35:51 node1 docker[4032]: f391a4589e37: Pull complete</span><br><span class="line">9月 01 17:35:51 node1 docker[4032]: Digest: sha256:34aa80bb22c79235d466ccbbfa3659ff815100ed21eddb1543c6847292010c4d</span><br><span class="line">9月 01 17:35:51 node1 docker[4032]: Status: Downloaded newer image for nginx:1.13.7-alpine</span><br><span class="line">9月 01 17:35:54 node1 docker[4032]: 2018/09/01 09:35:54 [notice] 1#1: using the &quot;epoll&quot; event method</span><br><span class="line">9月 01 17:35:54 node1 docker[4032]: 2018/09/01 09:35:54 [notice] 1#1: nginx/1.13.7</span><br><span class="line">9月 01 17:35:54 node1 docker[4032]: 2018/09/01 09:35:54 [notice] 1#1: built by gcc 6.2.1 20160822 (Alpine 6.2.1)</span><br><span class="line">9月 01 17:35:54 node1 docker[4032]: 2018/09/01 09:35:54 [notice] 1#1: OS: Linux 3.10.0-514.el7.x86_64</span><br><span class="line">9月 01 17:35:54 node1 docker[4032]: 2018/09/01 09:35:54 [notice] 1#1: getrlimit(RLIMIT_NOFILE): 1048576:1048576</span><br><span class="line">9月 01 17:35:54 node1 docker[4032]: 2018/09/01 09:35:54 [notice] 1#1: start worker processes</span><br><span class="line">9月 01 17:35:54 node1 docker[4032]: 2018/09/01 09:35:54 [notice] 1#1: start worker process 5</span><br></pre></td></tr></table></figure>
<h3 id="创建-kubelet-service-文件"><a href="#创建-kubelet-service-文件" class="headerlink" title="创建 kubelet.service 文件"></a>创建 kubelet.service 文件</h3><p>==注意修改节点的hostname↓==<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 创建 kubelet 目录</span><br><span class="line"></span><br><span class="line">mkdir -p /var/lib/kubelet</span><br><span class="line"></span><br><span class="line">vi /etc/systemd/system/kubelet.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/lib/kubelet</span><br><span class="line">ExecStart=/usr/local/bin/kubelet \</span><br><span class="line">  --hostname-override=node1 \</span><br><span class="line">  --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/zhdya_centos_docker/zhdya_cc:pause-amd64_3.1 \</span><br><span class="line">  --bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \</span><br><span class="line">  --config=/etc/kubernetes/kubelet.config.json \</span><br><span class="line">  --cert-dir=/etc/kubernetes/ssl \</span><br><span class="line">  --logtostderr=true \</span><br><span class="line">  --v=2</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure></p>
<h4 id="创建-kubelet-config-配置文件"><a href="#创建-kubelet-config-配置文件" class="headerlink" title="创建 kubelet config 配置文件"></a>创建 kubelet config 配置文件</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi /etc/kubernetes/kubelet.config.json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;kind&quot;: &quot;KubeletConfiguration&quot;,</span><br><span class="line">  &quot;apiVersion&quot;: &quot;kubelet.config.k8s.io/v1beta1&quot;,</span><br><span class="line">  &quot;authentication&quot;: &#123;</span><br><span class="line">    &quot;x509&quot;: &#123;</span><br><span class="line">      &quot;clientCAFile&quot;: &quot;/etc/kubernetes/ssl/ca.pem&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;webhook&quot;: &#123;</span><br><span class="line">      &quot;enabled&quot;: true,</span><br><span class="line">      &quot;cacheTTL&quot;: &quot;2m0s&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;anonymous&quot;: &#123;</span><br><span class="line">      &quot;enabled&quot;: false</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;authorization&quot;: &#123;</span><br><span class="line">    &quot;mode&quot;: &quot;Webhook&quot;,</span><br><span class="line">    &quot;webhook&quot;: &#123;</span><br><span class="line">      &quot;cacheAuthorizedTTL&quot;: &quot;5m0s&quot;,</span><br><span class="line">      &quot;cacheUnauthorizedTTL&quot;: &quot;30s&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;address&quot;: &quot;192.168.161.77&quot;,</span><br><span class="line">  &quot;port&quot;: 10250,</span><br><span class="line">  &quot;readOnlyPort&quot;: 0,</span><br><span class="line">  &quot;cgroupDriver&quot;: &quot;cgroupfs&quot;,</span><br><span class="line">  &quot;hairpinMode&quot;: &quot;promiscuous-bridge&quot;,</span><br><span class="line">  &quot;serializeImagePulls&quot;: false,</span><br><span class="line">  &quot;RotateCertificates&quot;: true,</span><br><span class="line">  &quot;featureGates&quot;: &#123;</span><br><span class="line">    &quot;RotateKubeletClientCertificate&quot;: true,</span><br><span class="line">    &quot;RotateKubeletServerCertificate&quot;: true</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;MaxPods&quot;: &quot;512&quot;,</span><br><span class="line">  &quot;failSwapOn&quot;: false,</span><br><span class="line">  &quot;containerLogMaxSize&quot;: &quot;10Mi&quot;,</span><br><span class="line">  &quot;containerLogMaxFiles&quot;: 5,</span><br><span class="line">  &quot;clusterDomain&quot;: &quot;cluster.local.&quot;,</span><br><span class="line">  &quot;clusterDNS&quot;: [&quot;10.254.0.2&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">##其它node节点记得修改如上的IP地址</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 如上配置:</span><br><span class="line">node1    本机hostname</span><br><span class="line">10.254.0.2       预分配的 dns 地址</span><br><span class="line">cluster.local.   为 kubernetes 集群的 domain</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/zhdya_centos_docker/zhdya_cc:pause-amd64_3.1  这个是 pod 的基础镜像，既 gcr 的 gcr.io/google_containers/pause-amd64:3.1 镜像， 下载下来修改为自己的仓库中的比较快。</span><br><span class="line">&quot;clusterDNS&quot;: [&quot;10.254.0.2&quot;] 可配置多个 dns地址，逗号可开, 可配置宿主机dns.</span><br></pre></td></tr></table></figure>
<p>++<strong>同理修改其它node节点</strong>++</p>
<p>启动 kubelet<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kubelet</span><br><span class="line">systemctl start kubelet</span><br><span class="line">systemctl status kubelet</span><br><span class="line"></span><br><span class="line">journalctl -u kubelet -f</span><br></pre></td></tr></table></figure></p>
<h3 id="创建-kube-proxy-证书"><a href="#创建-kube-proxy-证书" class="headerlink" title="创建 kube-proxy 证书"></a>创建 kube-proxy 证书</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 证书方面由于我们node端没有装 cfssl</span><br><span class="line"># 我们回到 master 端 机器 去配置证书，然后拷贝过来</span><br><span class="line"></span><br><span class="line">cd /opt/ssl</span><br><span class="line"></span><br><span class="line">vi kube-proxy-csr.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">  &quot;hosts&quot;: [],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;ShenZhen&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;ShenZhen&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">生成 kube-proxy 证书和私钥</span><br><span class="line">/opt/local/cfssl/cfssl gencert -ca=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  -ca-key=/etc/kubernetes/ssl/ca-key.pem \</span><br><span class="line">  -config=/opt/ssl/config.json \</span><br><span class="line">  -profile=kubernetes  kube-proxy-csr.json | /opt/local/cfssl/cfssljson -bare kube-proxy</span><br><span class="line">  </span><br><span class="line"># 查看生成</span><br><span class="line">ls kube-proxy*</span><br><span class="line">kube-proxy.csr  kube-proxy-csr.json  kube-proxy-key.pem  kube-proxy.pem</span><br><span class="line"></span><br><span class="line"># 拷贝到目录</span><br><span class="line"></span><br><span class="line">cp kube-proxy* /etc/kubernetes/ssl/</span><br><span class="line"></span><br><span class="line">scp ca.pem kube-proxy* 192.168.161.77:/etc/kubernetes/ssl/</span><br><span class="line"></span><br><span class="line">scp ca.pem kube-proxy* 192.168.161.78:/etc/kubernetes/ssl/</span><br></pre></td></tr></table></figure>
<h4 id="创建-kube-proxy-kubeconfig-文件"><a href="#创建-kube-proxy-kubeconfig-文件" class="headerlink" title="创建 kube-proxy kubeconfig 文件"></a>创建 kube-proxy kubeconfig 文件</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 配置集群</span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=https://127.0.0.1:6443 \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 配置客户端认证</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials kube-proxy \</span><br><span class="line">  --client-certificate=/etc/kubernetes/ssl/kube-proxy.pem \</span><br><span class="line">  --client-key=/etc/kubernetes/ssl/kube-proxy-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"># 配置关联</span><br><span class="line"></span><br><span class="line">kubectl config set-context default \</span><br><span class="line">  --cluster=kubernetes \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 配置默认关联</span><br><span class="line">kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"># 拷贝到需要的 node 端里</span><br><span class="line"></span><br><span class="line">scp kube-proxy.kubeconfig 192.168.161.77:/etc/kubernetes/</span><br><span class="line"></span><br><span class="line">scp kube-proxy.kubeconfig 192.168.161.78:/etc/kubernetes/</span><br></pre></td></tr></table></figure>
<h4 id="创建-kube-proxy-service-文件"><a href="#创建-kube-proxy-service-文件" class="headerlink" title="创建 kube-proxy.service 文件"></a>创建 kube-proxy.service 文件</h4><p>1.10 官方 ipvs 已经是默认的配置 <strong>–masquerade-all</strong> 必须添加这项配置，否则 创建 svc 在 ipvs 不会添加规则</p>
<p>打开 ipvs 需要安装 ipvsadm ipset conntrack 软件， 在 ==<strong>node</strong>== 中安装<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install ipset ipvsadm conntrack-tools.x86_64 -y</span><br></pre></td></tr></table></figure></p>
<p>yaml 配置文件中的 参数如下:</p>
<p><a href="https://github.com/kubernetes/kubernetes/blob/master/pkg/proxy/apis/kubeproxyconfig/types.go" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes/blob/master/pkg/proxy/apis/kubeproxyconfig/types.go</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cd /etc/kubernetes/</span><br><span class="line"></span><br><span class="line">vi  kube-proxy.config.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">bindAddress: 192.168.161.77</span><br><span class="line">clientConnection:</span><br><span class="line">  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line">clusterCIDR: 10.254.64.0/18</span><br><span class="line">healthzBindAddress: 192.168.161.77:10256</span><br><span class="line">hostnameOverride: node1             ##注意修改此处的hostname</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">metricsBindAddress: 192.168.161.77:10249</span><br><span class="line">mode: &quot;ipvs&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 创建 kube-proxy 目录</span><br><span class="line"></span><br><span class="line">mkdir -p /var/lib/kube-proxy</span><br><span class="line"></span><br><span class="line">vi /etc/systemd/system/kube-proxy.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kube-Proxy Server</span><br><span class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/lib/kube-proxy</span><br><span class="line">ExecStart=/usr/local/bin/kube-proxy \</span><br><span class="line">  --config=/etc/kubernetes/kube-proxy.config.yaml \</span><br><span class="line">  --logtostderr=true \</span><br><span class="line">  --v=1</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<h4 id="启动-kube-proxy"><a href="#启动-kube-proxy" class="headerlink" title="启动 kube-proxy"></a>启动 kube-proxy</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl enable kube-proxy</span><br><span class="line">systemctl start kube-proxy</span><br><span class="line">systemctl status kube-proxy</span><br></pre></td></tr></table></figure>
<h4 id="检查-ipvs-情况"><a href="#检查-ipvs-情况" class="headerlink" title="检查  ipvs  情况"></a>检查  ipvs  情况</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@node1 kubernetes]# ipvsadm -L -n</span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line">TCP  10.254.0.1:443 rr</span><br><span class="line">  -&gt; 192.168.161.161:6443         Masq    1      0          0</span><br><span class="line">  -&gt; 192.168.161.162:6443         Masq    1      0          0</span><br></pre></td></tr></table></figure>
<h2 id="配置-Calico-网络"><a href="#配置-Calico-网络" class="headerlink" title="配置 Calico 网络"></a>配置 Calico 网络</h2><p>官方文档 <a href="https://docs.projectcalico.org/v3.1/introduction" target="_blank" rel="noopener">https://docs.projectcalico.org/v3.1/introduction</a></p>
<h3 id="下载-Calico-yaml"><a href="#下载-Calico-yaml" class="headerlink" title="下载 Calico yaml"></a>下载 Calico yaml</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 下载 yaml 文件</span><br><span class="line"></span><br><span class="line">wget http://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/calico.yaml</span><br><span class="line"></span><br><span class="line">wget http://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/rbac.yaml</span><br></pre></td></tr></table></figure>
<h3 id="下载镜像"><a href="#下载镜像" class="headerlink" title="下载镜像"></a>下载镜像</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 下载 镜像</span><br><span class="line"></span><br><span class="line"># 国外镜像 有墙</span><br><span class="line">quay.io/calico/node:v3.1.3</span><br><span class="line">quay.io/calico/cni:v3.1.3</span><br><span class="line">quay.io/calico/kube-controllers:v3.1.3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 国内镜像</span><br><span class="line">jicki/node:v3.1.3</span><br><span class="line">jicki/cni:v3.1.3</span><br><span class="line">jicki/kube-controllers:v3.1.3</span><br><span class="line"></span><br><span class="line"># 阿里镜像</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/zhdya_centos_docker/zhdya_cc:node_v3.1.3</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/zhdya_centos_docker/zhdya_cc:cni_v3.1.3</span><br><span class="line">registry.cn-hangzhou.aliyuncs.com/zhdya_centos_docker/zhdya_cc:kube-controllers_v3.1.3</span><br><span class="line"></span><br><span class="line"># 替换镜像</span><br><span class="line">sed -i &apos;s/quay\.io\/calico/jicki/g&apos;  calico.yaml</span><br></pre></td></tr></table></figure>
<h3 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi calico.yaml</span><br><span class="line"></span><br><span class="line"># 注意修改如下选项:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># etcd 地址</span><br><span class="line"></span><br><span class="line">  etcd_endpoints: &quot;https://192.168.161.161:2379,https://192.168.161.162:2379,https://192.168.161.163:2379&quot;</span><br><span class="line">  </span><br><span class="line"> </span><br><span class="line"># etcd 证书路径</span><br><span class="line">  # If you&apos;re using TLS enabled etcd uncomment the following.</span><br><span class="line">  # You must also populate the Secret below with these files. </span><br><span class="line">    etcd_ca: &quot;/calico-secrets/etcd-ca&quot;  </span><br><span class="line">    etcd_cert: &quot;/calico-secrets/etcd-cert&quot;</span><br><span class="line">    etcd_key: &quot;/calico-secrets/etcd-key&quot;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># etcd 证书 base64 地址 (执行里面的命令生成的证书 base64 码，填入里面)</span><br><span class="line"></span><br><span class="line">data:</span><br><span class="line">  etcd-key: (cat /etc/kubernetes/ssl/etcd-key.pem | base64 | tr -d &apos;\n&apos;)</span><br><span class="line">  etcd-cert: (cat /etc/kubernetes/ssl/etcd.pem | base64 | tr -d &apos;\n&apos;)</span><br><span class="line">  etcd-ca: (cat /etc/kubernetes/ssl/ca.pem | base64 | tr -d &apos;\n&apos;)</span><br><span class="line">  </span><br><span class="line">## 如上需要去掉() 只需要填写生成的编码即可</span><br><span class="line">  </span><br><span class="line"># 修改 pods 分配的 IP 段</span><br><span class="line"></span><br><span class="line">            - name: CALICO_IPV4POOL_CIDR</span><br><span class="line">              value: &quot;10.254.64.0/18&quot;</span><br></pre></td></tr></table></figure>
<h3 id="查看服务"><a href="#查看服务" class="headerlink" title="查看服务"></a>查看服务</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@master1 kubernetes]# kubectl get po -n kube-system -o wide</span><br><span class="line">NAME                                      READY     STATUS    RESTARTS   AGE       IP               NODE      NOMINATED NODE</span><br><span class="line">calico-kube-controllers-79cfd7887-xbsd4   1/1       Running   5          11d       192.168.161.77   node1     &lt;none&gt;</span><br><span class="line">calico-node-2545t                         2/2       Running   0          29m       192.168.161.78   node2     &lt;none&gt;</span><br><span class="line">calico-node-tbptz                         2/2       Running   7          11d       192.168.161.77   node1     &lt;none&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 kubernetes]# kubectl get nodes -o wide</span><br><span class="line">NAME      STATUS    ROLES     AGE       VERSION   INTERNAL-IP      EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION          CONTAINER-RUNTIME</span><br><span class="line">node1     Ready     &lt;none&gt;    11d       v1.11.2   192.168.161.77   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-514.el7.x86_64   docker://17.3.2</span><br><span class="line">node2     Ready     &lt;none&gt;    29m       v1.11.2   192.168.161.78   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-514.el7.x86_64   docker://17.3.2</span><br></pre></td></tr></table></figure>
<h3 id="修改-kubelet-配置"><a href="#修改-kubelet-配置" class="headerlink" title="修改 kubelet 配置"></a>修改 kubelet 配置</h3><p>==两台node节点都需要配置==</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#   kubelet 需要增加 cni 插件    --network-plugin=cni</span><br><span class="line"></span><br><span class="line">vim /etc/systemd/system/kubelet.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  --network-plugin=cni \</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 重新加载配置</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart kubelet.service</span><br><span class="line">systemctl status kubelet.service</span><br></pre></td></tr></table></figure>
<p>检查网络的互通性：<br><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@node1 ~]# ifconfig</span><br><span class="line">tunl0: flags=193&lt;UP,RUNNING,NOARP&gt;  mtu 1440</span><br><span class="line">        inet 10.254.102.128  netmask 255.255.255.255</span><br><span class="line">        tunnel   txqueuelen 1  (IPIP Tunnel)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">[root@node2 ~]# ifconfig</span><br><span class="line">tunl0: flags=193&lt;UP,RUNNING,NOARP&gt;  mtu 1440</span><br><span class="line">        inet 10.254.75.0  netmask 255.255.255.255</span><br><span class="line">        tunnel   txqueuelen 1  (IPIP Tunnel)</span><br><span class="line">        RX packets 2  bytes 168 (168.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 2  bytes 168 (168.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">直接在node2上面ping：</span><br><span class="line"></span><br><span class="line">[root@node2 ~]# ping 10.254.102.128</span><br><span class="line">PING 10.254.102.128 (10.254.102.128) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.254.102.128: icmp_seq=1 ttl=64 time=72.3 ms</span><br><span class="line">64 bytes from 10.254.102.128: icmp_seq=2 ttl=64 time=0.272 ms</span><br></pre></td></tr></table></figure></p>
<h2 id="安装-calicoctl"><a href="#安装-calicoctl" class="headerlink" title="安装 calicoctl"></a>安装 calicoctl</h2><p>++calicoctl 是 calico 网络的管理客户端, 只需要在一台 node 里配置既可。++</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 下载 二进制文件</span><br><span class="line"></span><br><span class="line">curl -O -L https://github.com/projectcalico/calicoctl/releases/download/v3.1.3/calicoctl</span><br><span class="line"></span><br><span class="line">mv calicoctl /usr/local/bin/</span><br><span class="line"></span><br><span class="line">chmod +x /usr/local/bin/calicoctl</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 创建 calicoctl.cfg 配置文件</span><br><span class="line"></span><br><span class="line">mkdir /etc/calico</span><br><span class="line"></span><br><span class="line">vim /etc/calico/calicoctl.cfg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: projectcalico.org/v3</span><br><span class="line">kind: CalicoAPIConfig</span><br><span class="line">metadata:</span><br><span class="line">spec:</span><br><span class="line">  datastoreType: &quot;kubernetes&quot;</span><br><span class="line">  kubeconfig: &quot;/root/.kube/config&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 查看 calico 状态</span><br><span class="line"></span><br><span class="line">[root@node1 src]# calicoctl node status</span><br><span class="line">Calico process is running.</span><br><span class="line"></span><br><span class="line">IPv4 BGP status</span><br><span class="line">+----------------+-------------------+-------+----------+-------------+</span><br><span class="line">|  PEER ADDRESS  |     PEER TYPE     | STATE |  SINCE   |    INFO     |</span><br><span class="line">+----------------+-------------------+-------+----------+-------------+</span><br><span class="line">| 192.168.161.78 | node-to-node mesh | up    | 06:54:19 | Established |</span><br><span class="line">+----------------+-------------------+-------+----------+-------------+</span><br><span class="line"></span><br><span class="line">IPv6 BGP status</span><br><span class="line">No IPv6 peers found.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@node1 src]# calicoctl get node        ##当然我这边是在node节点操作的，node节点是没有/root/.kube/config 这个文件的，只需要从master节点copy过来即可！！</span><br><span class="line">NAME</span><br><span class="line">node1</span><br><span class="line">node2</span><br></pre></td></tr></table></figure>
            <hr>
          </div>
          <br>
          <div>
            <p>
            
              <span>
                <i class="iconfont icon-inbox"></i>
                
                  <a class="hover-with-bg" href="/categories/K8S">K8S</a>
                  &nbsp;
                
              </span>&nbsp;&nbsp;
            
            
              <span>
                <i class="iconfont icon-tag"></i>
                
                  <a class="hover-with-bg" href="/tags/Kubernets">Kubernets</a>
                
                  <a class="hover-with-bg" href="/tags/K8S">K8S</a>
                
              </span>
            
            </p>
            
              <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" rel="nofollow noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
            
          </div>
        </div>
      </div>
    </div>
    <div class="d-none d-lg-block col-lg-2 toc-container">
      
  <div id="toc">
    <p class="h4"><i class="far fa-list-alt"></i>&nbsp;目录</p>
    <div id="tocbot"></div>
  </div>

    </div>
  </div>
</div>

<!-- custom -->


<!-- Comments -->
<div class="col-lg-7 mx-auto nopadding-md">
  <div class="container comments mx-auto" id="comments">
    
      <br><br>
      
      
  <!--PC和WAP自适应版-->
  <div id="SOHUCS" sid="https://zhdya.okay686.cn/2019/02/09/kubernetes 1.11.2整理Ⅱ/"></div>
  <script type="text/javascript">
    (function () {
      var appid = 'cyu4TKmA0';
      var conf = '';
      var width = window.innerWidth || document.documentElement.clientWidth;
      if (width < 960) {
        var head = document.getElementsByTagName('head')[0] || document.head || document.documentElement;
        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.charset = 'utf-8';
        script.id = 'changyan_mobile_js';
        script.src = 'https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf;
        head.appendChild(script);
      } else {
        var loadJs = function (d, a) {
          var c = document.getElementsByTagName('head')[0] || document.head || document.documentElement;
          var b = document.createElement('script');
          b.setAttribute('type', 'text/javascript');
          b.setAttribute('charset', 'UTF-8');
          b.setAttribute('src', d);
          if (typeof a === 'function') {
            if (window.attachEvent) {
              b.onreadystatechange = function () {
                var e = b.readyState;
                if (e === 'loaded' || e === 'complete') {
                  b.onreadystatechange = null;
                  a();
                }
              };
            } else {
              b.onload = a;
            }
          }
          c.appendChild(b);
        };
        loadJs('https://changyan.sohu.com/upload/changyan.js', function () {
          window.changyan.api.config({ appid: appid, conf: conf });
        });
      }
    })(); </script>


    
  </div>
</div>

    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  <footer class="mt-5">
  <div class="text-center py-3">
    <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Hexo</b></a>
    <i class="iconfont icon-love"></i>
    <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"> <b>Fluid</b></a>
    <br>

    
  
    <!-- 不蒜子统计PV -->
    
    &nbsp;<span id="busuanzi_container_site_pv">总访问量 
          <span id="busuanzi_value_site_pv"></span> 次</span>&nbsp;
  
  
    <!-- 不蒜子统计UV -->
    
    &nbsp;<span id="busuanzi_container_site_uv">总访客数 
            <span id="busuanzi_value_site_uv"></span> 人</span>&nbsp;
  
  <br>



    
  <!-- 备案信息 -->
  <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">苏ICP备16041225号-2</a>
  



    <!-- cnzz Analytics icon -->
    

  </div>
</footer>

<!-- SCRIPTS -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/popper/popper.min.js"></script>
<script src="/lib/bootstrap/js/bootstrap.min.js"></script>
<script src="/lib/mdbootstrap/js/mdb.min.js"></script>
<script src="/js/main.js"></script>


  <script src="/js/lazyload.js"></script>



  
    <script src="/lib/tocbot/tocbot.min.js"></script>
  
  <script src="/js/post.js"></script>



  <script src="/lib/smooth-scroll/smooth-scroll.min.js"></script>



  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<!-- Plugins -->


  

  

  

  

  <!-- cnzz Analytics -->
  



  <script src="/lib/prettify/prettify.min.js"></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  ');
      prettyPrint();
    })
  </script>



  <script src="/lib/typed/typed.min.js"></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "kubernetes 1.11.2整理Ⅱ&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 50,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script src="/lib/anchor/anchor.min.js"></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "false",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script src="/js/local-search.js"></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script src="/lib/fancybox/jquery.fancybox.min.js"></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>





  
  
    <script>
      !function (e, t, a) {
        function r() {
          for (var e = 0; e < s.length; e++) s[e].alpha <= 0 ? (t.body.removeChild(s[e].el), s.splice(e, 1)) : (s[e].y--, s[e].scale += .004, s[e].alpha -= .013, s[e].el.style.cssText = "left:" + s[e].x + "px;top:" + s[e].y + "px;opacity:" + s[e].alpha + ";transform:scale(" + s[e].scale + "," + s[e].scale + ") rotate(45deg);background:" + s[e].color + ";z-index:99999");
          requestAnimationFrame(r)
        }

        function n() {
          var t = "function" == typeof e.onclick && e.onclick;
          e.onclick = function (e) {
            t && t(), o(e)
          }
        }

        function o(e) {
          var a = t.createElement("div");
          a.className = "heart", s.push({
            el: a,
            x: e.clientX - 5,
            y: e.clientY - 5,
            scale: 1,
            alpha: 1,
            color: c()
          }), t.body.appendChild(a)
        }

        function i(e) {
          var a = t.createElement("style");
          a.type = "text/css";
          try {
            a.appendChild(t.createTextNode(e))
          } catch (t) {
            a.styleSheet.cssText = e
          }
          t.getElementsByTagName("head")[0].appendChild(a)
        }

        function c() {
          return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
        }

        var s = [];
        e.requestAnimationFrame = e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.oRequestAnimationFrame || e.msRequestAnimationFrame || function (e) {
          setTimeout(e, 1e3 / 60)
        }, i(".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}"), n(), r()
      }(window, document);
    </script>
  



  <script>(function (i, s, o, g, r, a, m) {
      i['DaoVoiceObject'] = r;
      i[r] = i[r] ||
        function () {
          (i[r].q = i[r].q || []).push(arguments);
        };
      i[r].l = 1 * new Date();
      a = s.createElement(o);
      m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      a.charset = 'utf-8';
      m.parentNode.insertBefore(a, m);
    })(window, document, 'script', ('https:' === document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/f304979b.js", 'daovoice');
    daovoice('init', {
      app_id: "f304979b",
    });
    daovoice('update');
  </script>





</body>
</html>
