<!DOCTYPE html>
<html lang="zh-CN">





<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="description" content="Tough times never last, but tough people do.">
  <meta name="author" content="Zhdya">
  <meta name="keywords" content="">
  <title>ansible自动化部署kubernetes-1.16 ~ 拼！就对了！</title>

  <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="/lib/mdbootstrap/css/mdb.min.css">
<link rel="stylesheet" href="/lib/github-markdown/github-markdown.min.css">
<link rel="stylesheet" href="//at.alicdn.com/t/font_1067060_qzomjdt8bmp.css">


  <link rel="stylesheet" href="/lib/prettify/tomorrow-night-eighties.min.css">

<link rel="stylesheet" href="/css/main.css">


  <link rel="stylesheet" href="/lib/fancybox/jquery.fancybox.min.css">


</head>


<body>
  <header style="height: 60vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">&nbsp;<strong>拼！就对了！</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">首页</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">归档</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/categories/">分类</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">标签</a>
          </li>
        
          
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">关于</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background"
         style="background: url('/img/post.jpg')no-repeat center center;
           background-size: cover;
           background-attachment: fixed;">
      <div class="full-bg-img">
        <div class="mask rgba-black-light flex-center">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              <br>
              
                <p class="mt-3">
                  <i class="fas fa-calendar-alt" aria-hidden="true"></i>&nbsp;
                  星期四, 十二月 5日 2019, 12:00 凌晨
                </p>
              

              <p>
                
                  
                  &nbsp;<i class="far fa-chart-bar"></i>
                  <span class="post-count">
                    6.3k 字
                  </span>&nbsp;
                

                
                  
                  &nbsp;<i class="far fa-clock"></i>
                  <span class="post-count">
                      37 分钟
                  </span>&nbsp;
                

                
                  <!-- 不蒜子统计文章PV -->
                  
                  &nbsp;<i class="far fa-eye" aria-hidden="true"></i>&nbsp;
                  <span id="busuanzi_container_page_pv">
                    <span id="busuanzi_value_page_pv"></span> 次
                  </span>&nbsp;
                
              </p>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="py-5 z-depth-3" id="board">
        <div class="post-content mx-auto" id="post">
          <div class="markdown-body">
            <h3 id="概述："><a href="#概述：" class="headerlink" title="概述："></a>概述：</h3><p>集群包含coreDNS、cni、nginx-ingress、HA、flanneld</p>
<p>百度网盘链接：<a href="https://pan.baidu.com/s/1KYbpshhpTu62DnQwF1LUnQ" target="_blank" rel="noopener">https://pan.baidu.com/s/1KYbpshhpTu62DnQwF1LUnQ</a> 提取码：vi5e</p>
<h3 id="一、单master部署"><a href="#一、单master部署" class="headerlink" title="一、单master部署"></a>一、单master部署</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-ansible1 ~]# tree ansible-install-k8s-master</span><br><span class="line">ansible-install-k8s-master</span><br><span class="line">├── add-node.yml</span><br><span class="line">├── ansible.cfg</span><br><span class="line">├── group_vars</span><br><span class="line">│   └── all.yml</span><br><span class="line">├── hosts</span><br><span class="line">├── multi-master-deploy.yml</span><br><span class="line">├── multi-master.jpg</span><br><span class="line">├── README.md</span><br><span class="line">├── roles</span><br><span class="line">│   ├── addons</span><br><span class="line">│   │   ├── files</span><br><span class="line">│   │   │   ├── coredns.yaml</span><br><span class="line">│   │   │   ├── ingress-controller.yaml</span><br><span class="line">│   │   │   ├── kube-flannel.yaml</span><br><span class="line">│   │   │   └── kubernetes-dashboard.yaml</span><br><span class="line">│   │   └── tasks</span><br><span class="line">│   │       └── main.yml</span><br><span class="line">│   ├── common</span><br><span class="line">│   │   ├── tasks</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   └── templates</span><br><span class="line">│   │       └── hosts.j2</span><br><span class="line">│   ├── docker</span><br><span class="line">│   │   ├── files</span><br><span class="line">│   │   │   ├── daemon.json</span><br><span class="line">│   │   │   └── docker.service</span><br><span class="line">│   │   └── tasks</span><br><span class="line">│   │       └── main.yml</span><br><span class="line">│   ├── etcd</span><br><span class="line">│   │   ├── files</span><br><span class="line">│   │   │   └── etcd_cert</span><br><span class="line">│   │   │       ├── ca-key.pem</span><br><span class="line">│   │   │       ├── ca.pem</span><br><span class="line">│   │   │       ├── server-key.pem</span><br><span class="line">│   │   │       └── server.pem</span><br><span class="line">│   │   ├── tasks</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   └── templates</span><br><span class="line">│   │       ├── etcd.conf.j2</span><br><span class="line">│   │       ├── etcd.service.j2</span><br><span class="line">│   │       └── etcd.sh.j2</span><br><span class="line">│   ├── ha</span><br><span class="line">│   │   ├── files</span><br><span class="line">│   │   │   └── check_nginx.sh</span><br><span class="line">│   │   ├── tasks</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   └── templates</span><br><span class="line">│   │       ├── keepalived.conf.j2</span><br><span class="line">│   │       └── nginx.conf.j2</span><br><span class="line">│   ├── master</span><br><span class="line">│   │   ├── files</span><br><span class="line">│   │   │   ├── apiserver-to-kubelet-rbac.yaml</span><br><span class="line">│   │   │   ├── etcd_cert</span><br><span class="line">│   │   │   │   ├── ca.pem</span><br><span class="line">│   │   │   │   ├── server-key.pem</span><br><span class="line">│   │   │   │   └── server.pem</span><br><span class="line">│   │   │   ├── k8s_cert</span><br><span class="line">│   │   │   │   ├── admin-key.pem</span><br><span class="line">│   │   │   │   ├── admin.pem</span><br><span class="line">│   │   │   │   ├── ca-key.pem</span><br><span class="line">│   │   │   │   ├── ca.pem</span><br><span class="line">│   │   │   │   ├── kube-proxy-key.pem</span><br><span class="line">│   │   │   │   ├── kube-proxy.pem</span><br><span class="line">│   │   │   │   ├── server-key.pem</span><br><span class="line">│   │   │   │   └── server.pem</span><br><span class="line">│   │   │   ├── kubelet-bootstrap-rbac.yaml</span><br><span class="line">│   │   │   └── token.csv</span><br><span class="line">│   │   ├── tasks</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   └── templates</span><br><span class="line">│   │       ├── kube-apiserver.conf.j2</span><br><span class="line">│   │       ├── kube-apiserver.service.j2</span><br><span class="line">│   │       ├── kube-controller-manager.conf.j2</span><br><span class="line">│   │       ├── kube-controller-manager.service.j2</span><br><span class="line">│   │       ├── kube-scheduler.conf.j2</span><br><span class="line">│   │       └── kube-scheduler.service.j2</span><br><span class="line">│   ├── node</span><br><span class="line">│   │   ├── files</span><br><span class="line">│   │   │   └── k8s_cert</span><br><span class="line">│   │   │       ├── ca.pem</span><br><span class="line">│   │   │       ├── kube-proxy-key.pem</span><br><span class="line">│   │   │       └── kube-proxy.pem</span><br><span class="line">│   │   ├── tasks</span><br><span class="line">│   │   │   └── main.yml</span><br><span class="line">│   │   └── templates</span><br><span class="line">│   │       ├── bootstrap.kubeconfig.j2</span><br><span class="line">│   │       ├── kubelet-config.yml.j2</span><br><span class="line">│   │       ├── kubelet.conf.j2</span><br><span class="line">│   │       ├── kubelet.service.j2</span><br><span class="line">│   │       ├── kube-proxy-config.yml.j2</span><br><span class="line">│   │       ├── kube-proxy.conf.j2</span><br><span class="line">│   │       ├── kube-proxy.kubeconfig.j2</span><br><span class="line">│   │       └── kube-proxy.service.j2</span><br><span class="line">│   └── tls</span><br><span class="line">│       ├── files</span><br><span class="line">│       │   ├── generate_etcd_cert.sh</span><br><span class="line">│       │   └── generate_k8s_cert.sh</span><br><span class="line">│       ├── tasks</span><br><span class="line">│       │   └── main.yml</span><br><span class="line">│       └── templates</span><br><span class="line">│           ├── etcd</span><br><span class="line">│           │   ├── ca-config.json.j2</span><br><span class="line">│           │   ├── ca-csr.json.j2</span><br><span class="line">│           │   └── server-csr.json.j2</span><br><span class="line">│           └── k8s</span><br><span class="line">│               ├── admin-csr.json.j2</span><br><span class="line">│               ├── ca-config.json.j2</span><br><span class="line">│               ├── ca-csr.json.j2</span><br><span class="line">│               ├── kube-proxy-csr.json.j2</span><br><span class="line">│               └── server-csr.json.j2</span><br><span class="line">├── single-master-deploy.yml</span><br><span class="line">└── single-master.jpg</span><br></pre></td></tr></table></figure>
<h4 id="1-1、解压缩binary-pkg-tar-gz"><a href="#1-1、解压缩binary-pkg-tar-gz" class="headerlink" title="1.1、解压缩binary_pkg.tar.gz"></a>1.1、解压缩binary_pkg.tar.gz</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-ansible1 ~]# ls</span><br><span class="line">anaconda-ks.cfg  ansible-install-k8s-master  ansible-install-k8s-master.zip  binary_pkg.tar.gz</span><br><span class="line">[root@k8s-ansible1 ~]# tar zxvf binary_pkg.tar.gz</span><br></pre></td></tr></table></figure>
<h4 id="1-2、修改所以节点hosts-及ansible内的hosts"><a href="#1-2、修改所以节点hosts-及ansible内的hosts" class="headerlink" title="1.2、修改所以节点hosts 及ansible内的hosts"></a>1.2、修改所以节点hosts 及ansible内的hosts</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-ansible1 ~]# vim /etc/hosts</span><br><span class="line"></span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.171.11 k8s-ansible1     ##ansible机器</span><br><span class="line">192.168.171.12 k8s-ansible2     ##master</span><br><span class="line">192.168.171.13 k8s-ansible3     ##node1</span><br><span class="line">192.168.171.14 k8s-ansible4     ##node2</span><br><span class="line"></span><br><span class="line">[root@k8s-ansible1 ~]# cd ansible-install-k8s-master</span><br><span class="line"></span><br><span class="line">[root@k8s-ansible1 ansible-install-k8s-master]# cat hosts</span><br><span class="line">[master]</span><br><span class="line"># 如果部署单Master，只保留一个Master节点</span><br><span class="line">192.168.171.12 node_name=k8s-ansible2</span><br><span class="line">#192.168.171.111 node_name=k8s-master2</span><br><span class="line"></span><br><span class="line">[node]</span><br><span class="line">192.168.171.13 node_name=k8s-ansible3</span><br><span class="line">192.168.171.14 node_name=k8s-ansible4</span><br><span class="line"></span><br><span class="line">[etcd]</span><br><span class="line">192.168.171.12 etcd_name=k8s-ansible2</span><br><span class="line">192.168.171.13 etcd_name=k8s-ansible3</span><br><span class="line">192.168.171.14 etcd_name=k8s-ansible4</span><br><span class="line"></span><br><span class="line">[lb]</span><br><span class="line"># 如果部署单Master，该项忽略</span><br><span class="line">192.168.31.63 lb_name=lb-master</span><br><span class="line">192.168.31.71 lb_name=lb-backup</span><br><span class="line"></span><br><span class="line">[k8s:children]</span><br><span class="line">master</span><br><span class="line">node</span><br><span class="line"></span><br><span class="line">[newnode]</span><br><span class="line">#192.168.31.91 node_name=k8s-node3</span><br></pre></td></tr></table></figure>
<h4 id="1-3、更改全局环境配置"><a href="#1-3、更改全局环境配置" class="headerlink" title="1.3、更改全局环境配置"></a>1.3、更改全局环境配置</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-ansible1 ansible-install-k8s-master]# cat group_vars/all.yml</span><br><span class="line"># 安装目录</span><br><span class="line">software_dir: &apos;/root/binary_pkg&apos;</span><br><span class="line">k8s_work_dir: &apos;/opt/kubernetes&apos;</span><br><span class="line">etcd_work_dir: &apos;/opt/etcd&apos;</span><br><span class="line">tmp_dir: &apos;/tmp/k8s&apos;</span><br><span class="line"></span><br><span class="line"># 集群网络</span><br><span class="line">service_cidr: &apos;10.0.0.0/24&apos;</span><br><span class="line">cluster_dns: &apos;10.0.0.2&apos;   # 与roles/addons/files/coredns.yaml中IP一致</span><br><span class="line">pod_cidr: &apos;10.244.0.0/16&apos; # 与roles/addons/files/kube-flannel.yaml中网段一致</span><br><span class="line">service_nodeport_range: &apos;30000-32767&apos;</span><br><span class="line">cluster_domain: &apos;cluster.local&apos;</span><br><span class="line"></span><br><span class="line"># 高可用，如果部署单Master，该项忽略</span><br><span class="line">vip: &apos;192.168.31.88&apos;</span><br><span class="line">nic: &apos;ens33&apos;</span><br><span class="line"></span><br><span class="line"># 自签证书可信任IP列表，为方便扩展，可添加多个预留IP</span><br><span class="line">cert_hosts:</span><br><span class="line">  # 包含所有LB、VIP、Master（多多益善，可以多余出来几个后期扩展用） IP和service_cidr的第一个IP</span><br><span class="line">  k8s:</span><br><span class="line">    - 10.0.0.1</span><br><span class="line">    - 192.168.171.11</span><br><span class="line">    - 192.168.171.12</span><br><span class="line">    - 192.168.171.13</span><br><span class="line">    - 192.168.171.14</span><br><span class="line">    - 192.168.171.15</span><br><span class="line">    - 192.168.171.16</span><br><span class="line">    - 192.168.171.17</span><br><span class="line">    - 192.168.171.18</span><br><span class="line">    - 192.168.171.19</span><br><span class="line">    - 192.168.171.111</span><br><span class="line">  # 包含所有etcd节点IP</span><br><span class="line">  etcd:</span><br><span class="line">    - 192.168.171.12</span><br><span class="line">    - 192.168.171.13</span><br><span class="line">    - 192.168.171.14</span><br></pre></td></tr></table></figure>
<h3 id="二、准备部署"><a href="#二、准备部署" class="headerlink" title="二、准备部署"></a>二、准备部署</h3><h4 id="2-1、单Master版："><a href="#2-1、单Master版：" class="headerlink" title="2.1、单Master版："></a>2.1、单Master版：</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ansible-playbook -i hosts single-master-deploy.yml -uroot -k</span><br></pre></td></tr></table></figure>
<h4 id="2-2、历史记录"><a href="#2-2、历史记录" class="headerlink" title="2.2、历史记录"></a>2.2、历史记录</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-ansible1 ansible-install-k8s-master]# ansible-playbook -i hosts single-master-deploy.yml -uroot -k</span><br><span class="line">SSH password:</span><br><span class="line"></span><br><span class="line">PLAY [0.系统初始化] ********************************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [common : 关闭firewalld] *******************************************************************************************************************************************</span><br><span class="line">ok: [192.168.171.14]</span><br><span class="line">ok: [192.168.171.12]</span><br><span class="line">ok: [192.168.171.13]</span><br><span class="line"></span><br><span class="line">TASK [common : 关闭selinux] *********************************************************************************************************************************************</span><br><span class="line">ok: [192.168.171.14]</span><br><span class="line">ok: [192.168.171.13]</span><br><span class="line">ok: [192.168.171.12]</span><br><span class="line"></span><br><span class="line">TASK [common : 关闭swap] ************************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line">changed: [192.168.171.13]</span><br><span class="line">changed: [192.168.171.14]</span><br><span class="line"></span><br><span class="line">TASK [common : 即时生效] **************************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.13]</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line">changed: [192.168.171.14]</span><br><span class="line"></span><br><span class="line">TASK [common : 拷贝时区] **************************************************************************************************************************************************</span><br><span class="line">ok: [192.168.171.14]</span><br><span class="line">ok: [192.168.171.12]</span><br><span class="line">ok: [192.168.171.13]</span><br><span class="line"></span><br><span class="line">TASK [common : 添加hosts] ***********************************************************************************************************************************************</span><br><span class="line">ok: [192.168.171.12]</span><br><span class="line">ok: [192.168.171.14]</span><br><span class="line">ok: [192.168.171.13]</span><br><span class="line"></span><br><span class="line">PLAY [1.自签证书] *********************************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [tls : 获取Ansible工作目录] ********************************************************************************************************************************************</span><br><span class="line">changed: [localhost]</span><br><span class="line"></span><br><span class="line">TASK [tls : 创建工作目录] ***************************************************************************************************************************************************</span><br><span class="line">ok: [localhost] =&gt; (item=etcd)</span><br><span class="line">ok: [localhost] =&gt; (item=k8s)</span><br><span class="line"></span><br><span class="line">TASK [tls : 准备cfssl工具] ************************************************************************************************************************************************</span><br><span class="line">ok: [localhost]</span><br><span class="line"></span><br><span class="line">TASK [tls : 准备etcd证书请求文件] *********************************************************************************************************************************************</span><br><span class="line">ok: [localhost] =&gt; (item=ca-config.json.j2)</span><br><span class="line">ok: [localhost] =&gt; (item=ca-csr.json.j2)</span><br><span class="line">ok: [localhost] =&gt; (item=server-csr.json.j2)</span><br><span class="line"></span><br><span class="line">TASK [tls : 准备生成etcd证书脚本] *********************************************************************************************************************************************</span><br><span class="line">ok: [localhost]</span><br><span class="line"></span><br><span class="line">TASK [tls : 生成etcd证书] *************************************************************************************************************************************************</span><br><span class="line">changed: [localhost]</span><br><span class="line"></span><br><span class="line">TASK [tls : 准备k8s证书请求文件] **********************************************************************************************************************************************</span><br><span class="line">ok: [localhost] =&gt; (item=ca-config.json.j2)</span><br><span class="line">ok: [localhost] =&gt; (item=ca-csr.json.j2)</span><br><span class="line">ok: [localhost] =&gt; (item=server-csr.json.j2)</span><br><span class="line">ok: [localhost] =&gt; (item=admin-csr.json.j2)</span><br><span class="line">ok: [localhost] =&gt; (item=kube-proxy-csr.json.j2)</span><br><span class="line"></span><br><span class="line">TASK [tls : 准备生成k8s证书脚本] **********************************************************************************************************************************************</span><br><span class="line">ok: [localhost]</span><br><span class="line"></span><br><span class="line">TASK [tls : 生成k8s证书] **************************************************************************************************************************************************</span><br><span class="line">changed: [localhost]</span><br><span class="line"></span><br><span class="line">PLAY [2.部署Docker] *****************************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [docker : 创建临时目录] ************************************************************************************************************************************************</span><br><span class="line">ok: [192.168.171.12]</span><br><span class="line">ok: [192.168.171.13]</span><br><span class="line">ok: [192.168.171.14]</span><br><span class="line"></span><br><span class="line">TASK [docker : 分发并解压docker二进制包] ***************************************************************************************************************************************</span><br><span class="line">ok: [192.168.171.14] =&gt; (item=/root/binary_pkg/docker-18.09.6.tgz)</span><br><span class="line">ok: [192.168.171.12] =&gt; (item=/root/binary_pkg/docker-18.09.6.tgz)</span><br><span class="line">ok: [192.168.171.13] =&gt; (item=/root/binary_pkg/docker-18.09.6.tgz)</span><br><span class="line"></span><br><span class="line">TASK [docker : 移动docker二进制文件] *****************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.13]</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line">changed: [192.168.171.14]</span><br><span class="line"></span><br><span class="line">TASK [docker : 分发service文件] *******************************************************************************************************************************************</span><br><span class="line">ok: [192.168.171.12]</span><br><span class="line">ok: [192.168.171.13]</span><br><span class="line">ok: [192.168.171.14]</span><br><span class="line"></span><br><span class="line">TASK [docker : 创建目录] **************************************************************************************************************************************************</span><br><span class="line">ok: [192.168.171.12]</span><br><span class="line">ok: [192.168.171.13]</span><br><span class="line">ok: [192.168.171.14]</span><br><span class="line"></span><br><span class="line">TASK [docker : 配置docker] **********************************************************************************************************************************************</span><br><span class="line">ok: [192.168.171.12]</span><br><span class="line">ok: [192.168.171.13]</span><br><span class="line">ok: [192.168.171.14]</span><br><span class="line"></span><br><span class="line">TASK [docker : 启动docker] **********************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line">changed: [192.168.171.13]</span><br><span class="line">changed: [192.168.171.14]</span><br><span class="line"></span><br><span class="line">TASK [docker : 查看状态] **************************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line">changed: [192.168.171.13]</span><br><span class="line">changed: [192.168.171.14]</span><br><span class="line"></span><br><span class="line">TASK [docker : debug] *************************************************************************************************************************************************</span><br><span class="line">ok: [192.168.171.13] =&gt; &#123;</span><br><span class="line">    &quot;docker.stdout_lines&quot;: [</span><br><span class="line">        &quot;Containers: 0&quot;,</span><br><span class="line">        &quot; Running: 0&quot;,</span><br><span class="line">        &quot; Paused: 0&quot;,</span><br><span class="line">        &quot; Stopped: 0&quot;,</span><br><span class="line">        &quot;Images: 0&quot;,</span><br><span class="line">        &quot;Server Version: 18.09.6&quot;,</span><br><span class="line">        &quot;Storage Driver: overlay2&quot;,</span><br><span class="line">        &quot; Backing Filesystem: xfs&quot;,</span><br><span class="line">        &quot; Supports d_type: true&quot;,</span><br><span class="line">        &quot; Native Overlay Diff: true&quot;,</span><br><span class="line">        &quot;Logging Driver: json-file&quot;,</span><br><span class="line">        &quot;Cgroup Driver: cgroupfs&quot;,</span><br><span class="line">        &quot;Plugins:&quot;,</span><br><span class="line">        &quot; Volume: local&quot;,</span><br><span class="line">        &quot; Network: bridge host macvlan null overlay&quot;,</span><br><span class="line">        &quot; Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog&quot;,</span><br><span class="line">        &quot;Swarm: inactive&quot;,</span><br><span class="line">        &quot;Runtimes: runc&quot;,</span><br><span class="line">        &quot;Default Runtime: runc&quot;,</span><br><span class="line">        &quot;Init Binary: docker-init&quot;,</span><br><span class="line">        &quot;containerd version: bb71b10fd8f58240ca47fbb579b9d1028eea7c84&quot;,</span><br><span class="line">        &quot;runc version: 2b18fe1d885ee5083ef9f0838fee39b62d653e30&quot;,</span><br><span class="line">        &quot;init version: fec3683&quot;,</span><br><span class="line">        &quot;Security Options:&quot;,</span><br><span class="line">        &quot; seccomp&quot;,</span><br><span class="line">        &quot;  Profile: default&quot;,</span><br><span class="line">        &quot;Kernel Version: 3.10.0-957.el7.x86_64&quot;,</span><br><span class="line">        &quot;Operating System: CentOS Linux 7 (Core)&quot;,</span><br><span class="line">        &quot;OSType: linux&quot;,</span><br><span class="line">        &quot;Architecture: x86_64&quot;,</span><br><span class="line">        &quot;CPUs: 2&quot;,</span><br><span class="line">        &quot;Total Memory: 1.777GiB&quot;,</span><br><span class="line">        &quot;Name: k8s-ansible3&quot;,</span><br><span class="line">        &quot;ID: O3LF:KDZ3:CXD6:MU6T:3DKL:PS42:6ATX:R4QE:GMI7:QHNO:CVQO:7ZW6&quot;,</span><br><span class="line">        &quot;Docker Root Dir: /var/lib/docker&quot;,</span><br><span class="line">        &quot;Debug Mode (client): false&quot;,</span><br><span class="line">        &quot;Debug Mode (server): false&quot;,</span><br><span class="line">        &quot;Registry: https://index.docker.io/v1/&quot;,</span><br><span class="line">        &quot;Labels:&quot;,</span><br><span class="line">        &quot;Experimental: false&quot;,</span><br><span class="line">        &quot;Insecure Registries:&quot;,</span><br><span class="line">        &quot; 192.168.31.70&quot;,</span><br><span class="line">        &quot; 127.0.0.0/8&quot;,</span><br><span class="line">        &quot;Registry Mirrors:&quot;,</span><br><span class="line">        &quot; http://bc437cce.m.daocloud.io/&quot;,</span><br><span class="line">        &quot;Live Restore Enabled: false&quot;,</span><br><span class="line">        &quot;Product License: Community Engine&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">ok: [192.168.171.12] =&gt; &#123;</span><br><span class="line">    &quot;docker.stdout_lines&quot;: [</span><br><span class="line">        &quot;Containers: 0&quot;,</span><br><span class="line">        &quot; Running: 0&quot;,</span><br><span class="line">        &quot; Paused: 0&quot;,</span><br><span class="line">        &quot; Stopped: 0&quot;,</span><br><span class="line">        &quot;Images: 0&quot;,</span><br><span class="line">        &quot;Server Version: 18.09.6&quot;,</span><br><span class="line">        &quot;Storage Driver: overlay2&quot;,</span><br><span class="line">        &quot; Backing Filesystem: xfs&quot;,</span><br><span class="line">        &quot; Supports d_type: true&quot;,</span><br><span class="line">        &quot; Native Overlay Diff: true&quot;,</span><br><span class="line">        &quot;Logging Driver: json-file&quot;,</span><br><span class="line">        &quot;Cgroup Driver: cgroupfs&quot;,</span><br><span class="line">        &quot;Plugins:&quot;,</span><br><span class="line">        &quot; Volume: local&quot;,</span><br><span class="line">        &quot; Network: bridge host macvlan null overlay&quot;,</span><br><span class="line">        &quot; Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog&quot;,</span><br><span class="line">        &quot;Swarm: inactive&quot;,</span><br><span class="line">        &quot;Runtimes: runc&quot;,</span><br><span class="line">        &quot;Default Runtime: runc&quot;,</span><br><span class="line">        &quot;Init Binary: docker-init&quot;,</span><br><span class="line">        &quot;containerd version: bb71b10fd8f58240ca47fbb579b9d1028eea7c84&quot;,</span><br><span class="line">        &quot;runc version: 2b18fe1d885ee5083ef9f0838fee39b62d653e30&quot;,</span><br><span class="line">        &quot;init version: fec3683&quot;,</span><br><span class="line">        &quot;Security Options:&quot;,</span><br><span class="line">        &quot; seccomp&quot;,</span><br><span class="line">        &quot;  Profile: default&quot;,</span><br><span class="line">        &quot;Kernel Version: 3.10.0-957.el7.x86_64&quot;,</span><br><span class="line">        &quot;Operating System: CentOS Linux 7 (Core)&quot;,</span><br><span class="line">        &quot;OSType: linux&quot;,</span><br><span class="line">        &quot;Architecture: x86_64&quot;,</span><br><span class="line">        &quot;CPUs: 2&quot;,</span><br><span class="line">        &quot;Total Memory: 1.777GiB&quot;,</span><br><span class="line">        &quot;Name: k8s-ansible2&quot;,</span><br><span class="line">        &quot;ID: DFQT:2YYV:YWY5:IXSS:U6VS:BW7R:6MPH:WCLC:QKOW:Y63I:5TV6:C3HT&quot;,</span><br><span class="line">        &quot;Docker Root Dir: /var/lib/docker&quot;,</span><br><span class="line">        &quot;Debug Mode (client): false&quot;,</span><br><span class="line">        &quot;Debug Mode (server): false&quot;,</span><br><span class="line">        &quot;Registry: https://index.docker.io/v1/&quot;,</span><br><span class="line">        &quot;Labels:&quot;,</span><br><span class="line">        &quot;Experimental: false&quot;,</span><br><span class="line">        &quot;Insecure Registries:&quot;,</span><br><span class="line">        &quot; 192.168.31.70&quot;,</span><br><span class="line">        &quot; 127.0.0.0/8&quot;,</span><br><span class="line">        &quot;Registry Mirrors:&quot;,</span><br><span class="line">        &quot; http://bc437cce.m.daocloud.io/&quot;,</span><br><span class="line">        &quot;Live Restore Enabled: false&quot;,</span><br><span class="line">        &quot;Product License: Community Engine&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">ok: [192.168.171.14] =&gt; &#123;</span><br><span class="line">    &quot;docker.stdout_lines&quot;: [</span><br><span class="line">        &quot;Containers: 0&quot;,</span><br><span class="line">        &quot; Running: 0&quot;,</span><br><span class="line">        &quot; Paused: 0&quot;,</span><br><span class="line">        &quot; Stopped: 0&quot;,</span><br><span class="line">        &quot;Images: 0&quot;,</span><br><span class="line">        &quot;Server Version: 18.09.6&quot;,</span><br><span class="line">        &quot;Storage Driver: overlay2&quot;,</span><br><span class="line">        &quot; Backing Filesystem: xfs&quot;,</span><br><span class="line">        &quot; Supports d_type: true&quot;,</span><br><span class="line">        &quot; Native Overlay Diff: true&quot;,</span><br><span class="line">        &quot;Logging Driver: json-file&quot;,</span><br><span class="line">        &quot;Cgroup Driver: cgroupfs&quot;,</span><br><span class="line">        &quot;Plugins:&quot;,</span><br><span class="line">        &quot; Volume: local&quot;,</span><br><span class="line">        &quot; Network: bridge host macvlan null overlay&quot;,</span><br><span class="line">        &quot; Log: awslogs fluentd gcplogs gelf journald json-file local logentries splunk syslog&quot;,</span><br><span class="line">        &quot;Swarm: inactive&quot;,</span><br><span class="line">        &quot;Runtimes: runc&quot;,</span><br><span class="line">        &quot;Default Runtime: runc&quot;,</span><br><span class="line">        &quot;Init Binary: docker-init&quot;,</span><br><span class="line">        &quot;containerd version: bb71b10fd8f58240ca47fbb579b9d1028eea7c84&quot;,</span><br><span class="line">        &quot;runc version: 2b18fe1d885ee5083ef9f0838fee39b62d653e30&quot;,</span><br><span class="line">        &quot;init version: fec3683&quot;,</span><br><span class="line">        &quot;Security Options:&quot;,</span><br><span class="line">        &quot; seccomp&quot;,</span><br><span class="line">        &quot;  Profile: default&quot;,</span><br><span class="line">        &quot;Kernel Version: 3.10.0-957.el7.x86_64&quot;,</span><br><span class="line">        &quot;Operating System: CentOS Linux 7 (Core)&quot;,</span><br><span class="line">        &quot;OSType: linux&quot;,</span><br><span class="line">        &quot;Architecture: x86_64&quot;,</span><br><span class="line">        &quot;CPUs: 2&quot;,</span><br><span class="line">        &quot;Total Memory: 1.777GiB&quot;,</span><br><span class="line">        &quot;Name: k8s-ansible4&quot;,</span><br><span class="line">        &quot;ID: M3EP:OAKQ:6AMI:RDC6:QX2H:U34M:5GTT:Q2E7:AFP7:C4M3:FUO2:UHS3&quot;,</span><br><span class="line">        &quot;Docker Root Dir: /var/lib/docker&quot;,</span><br><span class="line">        &quot;Debug Mode (client): false&quot;,</span><br><span class="line">        &quot;Debug Mode (server): false&quot;,</span><br><span class="line">        &quot;Registry: https://index.docker.io/v1/&quot;,</span><br><span class="line">        &quot;Labels:&quot;,</span><br><span class="line">        &quot;Experimental: false&quot;,</span><br><span class="line">        &quot;Insecure Registries:&quot;,</span><br><span class="line">        &quot; 192.168.31.70&quot;,</span><br><span class="line">        &quot; 127.0.0.0/8&quot;,</span><br><span class="line">        &quot;Registry Mirrors:&quot;,</span><br><span class="line">        &quot; http://bc437cce.m.daocloud.io/&quot;,</span><br><span class="line">        &quot;Live Restore Enabled: false&quot;,</span><br><span class="line">        &quot;Product License: Community Engine&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY [3.部署ETCD集群] *****************************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [etcd : 创建工作目录] **************************************************************************************************************************************************</span><br><span class="line">ok: [192.168.171.12] =&gt; (item=bin)</span><br><span class="line">ok: [192.168.171.13] =&gt; (item=bin)</span><br><span class="line">ok: [192.168.171.14] =&gt; (item=bin)</span><br><span class="line">ok: [192.168.171.12] =&gt; (item=cfg)</span><br><span class="line">ok: [192.168.171.13] =&gt; (item=cfg)</span><br><span class="line">ok: [192.168.171.14] =&gt; (item=cfg)</span><br><span class="line">ok: [192.168.171.12] =&gt; (item=ssl)</span><br><span class="line">ok: [192.168.171.13] =&gt; (item=ssl)</span><br><span class="line">ok: [192.168.171.14] =&gt; (item=ssl)</span><br><span class="line"></span><br><span class="line">TASK [etcd : 创建临时目录] **************************************************************************************************************************************************</span><br><span class="line">ok: [192.168.171.12]</span><br><span class="line">ok: [192.168.171.13]</span><br><span class="line">ok: [192.168.171.14]</span><br><span class="line"></span><br><span class="line">TASK [etcd : 分发并解压etcd二进制包] *******************************************************************************************************************************************</span><br><span class="line">ok: [192.168.171.12] =&gt; (item=/root/binary_pkg/etcd-v3.3.13-linux-amd64.tar.gz)</span><br><span class="line">ok: [192.168.171.14] =&gt; (item=/root/binary_pkg/etcd-v3.3.13-linux-amd64.tar.gz)</span><br><span class="line">ok: [192.168.171.13] =&gt; (item=/root/binary_pkg/etcd-v3.3.13-linux-amd64.tar.gz)</span><br><span class="line"></span><br><span class="line">TASK [etcd : 移动etcd二进制文件] *********************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line">changed: [192.168.171.14]</span><br><span class="line">changed: [192.168.171.13]</span><br><span class="line"></span><br><span class="line">TASK [etcd : 分发证书] ****************************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=ca.pem)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=ca.pem)</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=ca.pem)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=server.pem)</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=server.pem)</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=server.pem)</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=server-key.pem)</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=server-key.pem)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=server-key.pem)</span><br><span class="line"></span><br><span class="line">TASK [etcd : 分发etcd配置文件] **********************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line">changed: [192.168.171.13]</span><br><span class="line">changed: [192.168.171.14]</span><br><span class="line"></span><br><span class="line">TASK [etcd : 分发service文件] *********************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line">changed: [192.168.171.13]</span><br><span class="line">changed: [192.168.171.14]</span><br><span class="line"></span><br><span class="line">TASK [etcd : 启动etcd] **************************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.14]</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line">changed: [192.168.171.13]</span><br><span class="line"></span><br><span class="line">TASK [etcd : 分发etcd脚本] ************************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line">changed: [192.168.171.14]</span><br><span class="line">changed: [192.168.171.13]</span><br><span class="line"></span><br><span class="line">TASK [etcd : 获取etcd集群状态] **********************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line">changed: [192.168.171.13]</span><br><span class="line">changed: [192.168.171.14]</span><br><span class="line"></span><br><span class="line">TASK [etcd : debug] ***************************************************************************************************************************************************</span><br><span class="line">ok: [192.168.171.13] =&gt; &#123;</span><br><span class="line">    &quot;status.stdout_lines&quot;: [</span><br><span class="line">        &quot;member 5da6acb8be0f9647 is healthy: got healthy result from https://192.168.171.14:2379&quot;,</span><br><span class="line">        &quot;member a747b20fc3712bbc is healthy: got healthy result from https://192.168.171.12:2379&quot;,</span><br><span class="line">        &quot;member f351513a2b4642ac is healthy: got healthy result from https://192.168.171.13:2379&quot;,</span><br><span class="line">        &quot;cluster is healthy&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">ok: [192.168.171.12] =&gt; &#123;</span><br><span class="line">    &quot;status.stdout_lines&quot;: [</span><br><span class="line">        &quot;member 5da6acb8be0f9647 is healthy: got healthy result from https://192.168.171.14:2379&quot;,</span><br><span class="line">        &quot;member a747b20fc3712bbc is healthy: got healthy result from https://192.168.171.12:2379&quot;,</span><br><span class="line">        &quot;member f351513a2b4642ac is healthy: got healthy result from https://192.168.171.13:2379&quot;,</span><br><span class="line">        &quot;cluster is healthy&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">ok: [192.168.171.14] =&gt; &#123;</span><br><span class="line">    &quot;status.stdout_lines&quot;: [</span><br><span class="line">        &quot;member 5da6acb8be0f9647 is healthy: got healthy result from https://192.168.171.14:2379&quot;,</span><br><span class="line">        &quot;member a747b20fc3712bbc is healthy: got healthy result from https://192.168.171.12:2379&quot;,</span><br><span class="line">        &quot;member f351513a2b4642ac is healthy: got healthy result from https://192.168.171.13:2379&quot;,</span><br><span class="line">        &quot;cluster is healthy&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY [4.部署K8S Master] *************************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [master : 创建工作目录] ************************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=bin)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=cfg)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=ssl)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=logs)</span><br><span class="line"></span><br><span class="line">TASK [master : 创建临时目录] ************************************************************************************************************************************************</span><br><span class="line">ok: [192.168.171.12]</span><br><span class="line"></span><br><span class="line">TASK [master : 分发并解压k8s二进制包] ******************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=/root/binary_pkg/kubernetes-server-linux-amd64-1.16.tar.gz)</span><br><span class="line"></span><br><span class="line">TASK [master : 移动k8s master二进制文件] *************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line"></span><br><span class="line">TASK [master : 分发k8s证书] ***********************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=ca.pem)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=ca-key.pem)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=server.pem)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=server-key.pem)</span><br><span class="line"></span><br><span class="line">TASK [master : 分发etcd证书] **********************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=ca.pem)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=server.pem)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=server-key.pem)</span><br><span class="line"></span><br><span class="line">TASK [master : 分发token文件] *********************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line"></span><br><span class="line">TASK [master : 分发k8s配置文件] *********************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=kube-apiserver.conf.j2)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=kube-controller-manager.conf.j2)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=kube-scheduler.conf.j2)</span><br><span class="line"></span><br><span class="line">TASK [master : 分发service文件] *******************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=kube-apiserver.service.j2)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=kube-controller-manager.service.j2)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=kube-scheduler.service.j2)</span><br><span class="line"></span><br><span class="line">TASK [master : 启动k8s master组件] ****************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=kube-apiserver)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=kube-controller-manager)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=kube-scheduler)</span><br><span class="line"></span><br><span class="line">TASK [master : 查看集群状态] ************************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line"></span><br><span class="line">TASK [master : debug] *************************************************************************************************************************************************</span><br><span class="line">ok: [192.168.171.12] =&gt; &#123;</span><br><span class="line">    &quot;cs.stdout_lines&quot;: [</span><br><span class="line">        &quot;NAME                 AGE&quot;,</span><br><span class="line">        &quot;scheduler            &lt;unknown&gt;&quot;,</span><br><span class="line">        &quot;controller-manager   &lt;unknown&gt;&quot;,</span><br><span class="line">        &quot;etcd-0               &lt;unknown&gt;&quot;,</span><br><span class="line">        &quot;etcd-1               &lt;unknown&gt;&quot;,</span><br><span class="line">        &quot;etcd-2               &lt;unknown&gt;&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [master : 拷贝RBAC文件] **********************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=kubelet-bootstrap-rbac.yaml)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=apiserver-to-kubelet-rbac.yaml)</span><br><span class="line"></span><br><span class="line">TASK [master : 授权APIServer访问Kubelet与授权kubelet bootstrap] **************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line"></span><br><span class="line">PLAY [5.部署K8S Node] ***************************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [node : 创建工作目录] **************************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=bin)</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=bin)</span><br><span class="line">ok: [192.168.171.12] =&gt; (item=bin)</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=cfg)</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=cfg)</span><br><span class="line">ok: [192.168.171.12] =&gt; (item=cfg)</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=ssl)</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=ssl)</span><br><span class="line">ok: [192.168.171.12] =&gt; (item=ssl)</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=logs)</span><br><span class="line">ok: [192.168.171.12] =&gt; (item=logs)</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=logs)</span><br><span class="line"></span><br><span class="line">TASK [node : 创建cni插件目录] ***********************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=/opt/cni/bin)</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=/opt/cni/bin)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=/opt/cni/bin)</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=/etc/cni/net.d)</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=/etc/cni/net.d)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=/etc/cni/net.d)</span><br><span class="line"></span><br><span class="line">TASK [node : 创建临时目录] **************************************************************************************************************************************************</span><br><span class="line">ok: [192.168.171.12]</span><br><span class="line">ok: [192.168.171.13]</span><br><span class="line">ok: [192.168.171.14]</span><br><span class="line"></span><br><span class="line">TASK [node : 分发并解压k8s二进制包] ********************************************************************************************************************************************</span><br><span class="line">ok: [192.168.171.12] =&gt; (item=/root/binary_pkg/kubernetes-server-linux-amd64-1.16.tar.gz)</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=/root/binary_pkg/kubernetes-server-linux-amd64-1.16.tar.gz)</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=/root/binary_pkg/kubernetes-server-linux-amd64-1.16.tar.gz)</span><br><span class="line"></span><br><span class="line">TASK [node : 分发并解压cni插件二进制包] ******************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=/root/binary_pkg/cni-plugins-linux-amd64-v0.8.2.tgz)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=/root/binary_pkg/cni-plugins-linux-amd64-v0.8.2.tgz)</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=/root/binary_pkg/cni-plugins-linux-amd64-v0.8.2.tgz)</span><br><span class="line"></span><br><span class="line">TASK [node : 移动k8s node二进制文件] *****************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line">changed: [192.168.171.13]</span><br><span class="line">changed: [192.168.171.14]</span><br><span class="line"></span><br><span class="line">TASK [node : 分发k8s证书] *************************************************************************************************************************************************</span><br><span class="line">ok: [192.168.171.12] =&gt; (item=ca.pem)</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=ca.pem)</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=ca.pem)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=kube-proxy.pem)</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=kube-proxy.pem)</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=kube-proxy.pem)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=kube-proxy-key.pem)</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=kube-proxy-key.pem)</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=kube-proxy-key.pem)</span><br><span class="line"></span><br><span class="line">TASK [node : 分发k8s配置文件] ***********************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=bootstrap.kubeconfig.j2)</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=bootstrap.kubeconfig.j2)</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=bootstrap.kubeconfig.j2)</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=kubelet.conf.j2)</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=kubelet.conf.j2)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=kubelet.conf.j2)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=kubelet-config.yml.j2)</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=kubelet-config.yml.j2)</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=kubelet-config.yml.j2)</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=kube-proxy.kubeconfig.j2)</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=kube-proxy.kubeconfig.j2)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=kube-proxy.kubeconfig.j2)</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=kube-proxy.conf.j2)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=kube-proxy.conf.j2)</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=kube-proxy.conf.j2)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=kube-proxy-config.yml.j2)</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=kube-proxy-config.yml.j2)</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=kube-proxy-config.yml.j2)</span><br><span class="line"></span><br><span class="line">TASK [node : 分发service文件] *********************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=kubelet.service.j2)</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=kubelet.service.j2)</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=kubelet.service.j2)</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=kube-proxy.service.j2)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=kube-proxy.service.j2)</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=kube-proxy.service.j2)</span><br><span class="line"></span><br><span class="line">TASK [node : 启动k8s node组件] ********************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=kubelet)</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=kubelet)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=kubelet)</span><br><span class="line">changed: [192.168.171.14] =&gt; (item=kube-proxy)</span><br><span class="line">changed: [192.168.171.13] =&gt; (item=kube-proxy)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=kube-proxy)</span><br><span class="line"></span><br><span class="line">TASK [node : 分发预准备镜像] *************************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.14]</span><br><span class="line">changed: [192.168.171.13]</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line"></span><br><span class="line">TASK [node : 导入镜像] ****************************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line">changed: [192.168.171.14]</span><br><span class="line">changed: [192.168.171.13]</span><br><span class="line"></span><br><span class="line">PLAY [6.部署插件] *********************************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [addons : 允许Node加入集群] ********************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line"></span><br><span class="line">TASK [addons : 拷贝YAML文件到Master] ***************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=/root/ansible-install-k8s-master/roles/addons/files/coredns.yaml)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=/root/ansible-install-k8s-master/roles/addons/files/ingress-controller.yaml)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=/root/ansible-install-k8s-master/roles/addons/files/kube-flannel.yaml)</span><br><span class="line">changed: [192.168.171.12] =&gt; (item=/root/ansible-install-k8s-master/roles/addons/files/kubernetes-dashboard.yaml)</span><br><span class="line"></span><br><span class="line">TASK [addons : 部署Flannel,Dashboard,CoreDNS,Ingress] *******************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line"></span><br><span class="line">TASK [addons : 替换Dashboard证书] *****************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line"></span><br><span class="line">TASK [addons : 查看Pod状态] ***********************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line"></span><br><span class="line">TASK [addons : debug] *************************************************************************************************************************************************</span><br><span class="line">ok: [192.168.171.12] =&gt; &#123;</span><br><span class="line">    &quot;getall.stdout_lines&quot;: [</span><br><span class="line">        &quot;NAMESPACE              NAME                                             READY   STATUS    RESTARTS   AGE&quot;,</span><br><span class="line">        &quot;kube-system            pod/coredns-6d8cfdd59d-hcfw5                     0/1     Pending   0          2s&quot;,</span><br><span class="line">        &quot;kubernetes-dashboard   pod/dashboard-metrics-scraper-566cddb686-nk7t8   0/1     Pending   0          1s&quot;,</span><br><span class="line">        &quot;kubernetes-dashboard   pod/kubernetes-dashboard-c4bc5bd44-cxgb6         0/1     Pending   0          1s&quot;,</span><br><span class="line">        &quot;&quot;,</span><br><span class="line">        &quot;NAMESPACE              NAME                                TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)          AGE&quot;,</span><br><span class="line">        &quot;default                service/kubernetes                  ClusterIP   10.0.0.1     &lt;none&gt;        443/TCP          2m19s&quot;,</span><br><span class="line">        &quot;ingress-nginx          service/ingress-nginx               ClusterIP   10.0.0.158   &lt;none&gt;        80/TCP,443/TCP   2s&quot;,</span><br><span class="line">        &quot;kube-system            service/kube-dns                    ClusterIP   10.0.0.2     &lt;none&gt;        53/UDP,53/TCP    2s&quot;,</span><br><span class="line">        &quot;kubernetes-dashboard   service/dashboard-metrics-scraper   ClusterIP   10.0.0.38    &lt;none&gt;        8000/TCP         1s&quot;,</span><br><span class="line">        &quot;kubernetes-dashboard   service/kubernetes-dashboard        NodePort    10.0.0.180   &lt;none&gt;        443:30001/TCP    1s&quot;,</span><br><span class="line">        &quot;&quot;,</span><br><span class="line">        &quot;NAMESPACE       NAME                                      DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE&quot;,</span><br><span class="line">        &quot;ingress-nginx   daemonset.apps/nginx-ingress-controller   0         0         0       0            0           &lt;none&gt;          2s&quot;,</span><br><span class="line">        &quot;kube-system     daemonset.apps/kube-flannel-ds-amd64      0         0         0       0            0           &lt;none&gt;          2s&quot;,</span><br><span class="line">        &quot;&quot;,</span><br><span class="line">        &quot;NAMESPACE              NAME                                        READY   UP-TO-DATE   AVAILABLE   AGE&quot;,</span><br><span class="line">        &quot;kube-system            deployment.apps/coredns                     0/1     1            0           2s&quot;,</span><br><span class="line">        &quot;kubernetes-dashboard   deployment.apps/dashboard-metrics-scraper   0/1     1            0           1s&quot;,</span><br><span class="line">        &quot;kubernetes-dashboard   deployment.apps/kubernetes-dashboard        0/1     1            0           1s&quot;,</span><br><span class="line">        &quot;&quot;,</span><br><span class="line">        &quot;NAMESPACE              NAME                                                   DESIRED   CURRENT   READY   AGE&quot;,</span><br><span class="line">        &quot;kube-system            replicaset.apps/coredns-6d8cfdd59d                     1         1         0       2s&quot;,</span><br><span class="line">        &quot;kubernetes-dashboard   replicaset.apps/dashboard-metrics-scraper-566cddb686   1         1         0       1s&quot;,</span><br><span class="line">        &quot;kubernetes-dashboard   replicaset.apps/kubernetes-dashboard-c4bc5bd44         1         1         0       1s&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [addons : 创建Dashboard管理员令牌] **************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line"></span><br><span class="line">TASK [addons : 获取Dashboard管理员令牌] **************************************************************************************************************************************</span><br><span class="line">changed: [192.168.171.12]</span><br><span class="line"></span><br><span class="line">TASK [addons : Kubernetes Dashboard登录信息] ******************************************************************************************************************************</span><br><span class="line">ok: [192.168.171.12] =&gt; &#123;</span><br><span class="line">    &quot;ui.stdout_lines&quot;: [</span><br><span class="line">        &quot;访问地址---&gt;https://NodeIP:30001&quot;,</span><br><span class="line">        &quot;令牌内容---&gt;eyJhbGciOiJSUzI1NiIsImtpZCI6IlhOV0FZU1ZXRU80MU5oRUlYeGsxbExFcVB1R1k0bEEzMDhQQWdWVE5oZG8ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4tenQ2Y3ciLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiMTU3YjEyYmYtNjNjNC00NzU1LWI4YTAtN2IyY2ZkZmRmNmE3Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmVybmV0ZXMtZGFzaGJvYXJkOmRhc2hib2FyZC1hZG1pbiJ9.fKCHvmsmZmIErB9YLHtQrqWQBL_b89W0i_gDa4rwgV9x4UfzVAXskUiZiQs_yAHNmyUaIqPpBdUI64pvAoXilr-6wIk8-R8hpp4BJXLL4OsTtPXxrhIQF4_NP0D-4flg9sHba-I9X9A_2RWskcY53PAPTOjlyOQuldUyTdIT9tXi6jeSgj8CrDBc9O_A3xYWZ1f7RvrdEdU4Kkotc1rsBeGg-OzabU1nNLxWAaDHZJFciYeABtbPoY2fTkdz0JGoIxLpAqcQKoFp9ztGPcoOboCOqeb_hc-caBAmyvVIfbPvBiywdtuidjvb1IazETt_GQlzg7FMBoUpHhJYOTvnAA&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP ************************************************************************************************************************************************************</span><br><span class="line">192.168.171.12             : ok=61   changed=40   unreachable=0    failed=0</span><br><span class="line">192.168.171.13             : ok=38   changed=23   unreachable=0    failed=0</span><br><span class="line">192.168.171.14             : ok=38   changed=23   unreachable=0    failed=0</span><br><span class="line">localhost                  : ok=9    changed=3    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>
<h4 id="2-3、测试"><a href="#2-3、测试" class="headerlink" title="2.3、测试"></a>2.3、测试</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-ansible2 ~]# kubectl get nodes</span><br><span class="line">NAME           STATUS   ROLES    AGE    VERSION</span><br><span class="line">k8s-ansible2   Ready    &lt;none&gt;   117s   v1.16.0</span><br><span class="line">k8s-ansible3   Ready    &lt;none&gt;   117s   v1.16.0</span><br><span class="line">k8s-ansible4   Ready    &lt;none&gt;   117s   v1.16.0</span><br><span class="line"></span><br><span class="line">[root@k8s-ansible2 ~]# kubectl get po --all-namespaces -o wide</span><br><span class="line">NAMESPACE              NAME                                         READY   STATUS    RESTARTS   AGE     IP               NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">ingress-nginx          nginx-ingress-controller-7g9fh               1/1     Running   0          2m41s   192.168.171.13   k8s-ansible3   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">ingress-nginx          nginx-ingress-controller-hc492               1/1     Running   0          2m41s   192.168.171.14   k8s-ansible4   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">ingress-nginx          nginx-ingress-controller-s4slm               1/1     Running   0          2m41s   192.168.171.12   k8s-ansible2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system            coredns-6d8cfdd59d-hcfw5                     1/1     Running   0          3m8s    10.244.1.2       k8s-ansible2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system            kube-flannel-ds-amd64-6nbt4                  1/1     Running   0          2m51s   192.168.171.12   k8s-ansible2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system            kube-flannel-ds-amd64-mfksz                  1/1     Running   0          2m51s   192.168.171.14   k8s-ansible4   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system            kube-flannel-ds-amd64-vclgg                  1/1     Running   0          2m51s   192.168.171.13   k8s-ansible3   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kubernetes-dashboard   dashboard-metrics-scraper-566cddb686-nk7t8   1/1     Running   0          3m7s    10.244.2.2       k8s-ansible4   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kubernetes-dashboard   kubernetes-dashboard-c4bc5bd44-cxgb6         1/1     Running   0          3m7s    10.244.0.2       k8s-ansible3   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">[root@k8s-ansible2 ~]# kubectl get csr</span><br><span class="line">NAME                                                   AGE    REQUESTOR           CONDITION</span><br><span class="line">node-csr-96KwqYYgTQ0ajISzq2pUc5Dzu07UzjaKRZqRWs31yUk   5m5s   kubelet-bootstrap   Approved,Issued</span><br><span class="line">node-csr-9PduNyHHpXtDmuNFj3fCkpoNkGcDkO2NPEk3uGQ3kIk   5m6s   kubelet-bootstrap   Approved,Issued</span><br><span class="line">node-csr-WLFKgflHlDK2f0RFvuTYKlkHcr8hz0iOrzYcp2V50JE   5m6s   kubelet-bootstrap   Approved,Issued</span><br></pre></td></tr></table></figure>
<p><img src="http://myimage.okay686.cn/okay686cn/20191204/RlnwtcB5dboO.png?imageslim" srcset="/img/loading.gif" alt="mark"></p>
<hr>
<h3 id="三、多master部署"><a href="#三、多master部署" class="headerlink" title="三、多master部署"></a>三、多master部署</h3><h4 id="3-1、hosts"><a href="#3-1、hosts" class="headerlink" title="3.1、hosts"></a>3.1、hosts</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-ansible1 ansible-install-k8s-master]# cat hosts</span><br><span class="line">[master]</span><br><span class="line"># 如果部署单Master，只保留一个Master节点</span><br><span class="line">192.168.171.11 node_name=k8s-master1</span><br><span class="line">192.168.171.12 node_name=k8s-master2</span><br><span class="line"></span><br><span class="line">[node]</span><br><span class="line">192.168.171.13 node_name=k8s-node1</span><br><span class="line">192.168.171.14 node_name=k8s-node2</span><br><span class="line"></span><br><span class="line">[etcd]</span><br><span class="line">192.168.171.11 etcd_name=etcd-1</span><br><span class="line">192.168.171.12 etcd_name=etcd-2</span><br><span class="line">192.168.171.13 etcd_name=etcd-3</span><br><span class="line"></span><br><span class="line">[lb]</span><br><span class="line"># 如果部署单Master，该项忽略</span><br><span class="line">192.168.171.15 lb_name=lb-master</span><br><span class="line">192.168.171.16 lb_name=lb-backup</span><br><span class="line"></span><br><span class="line">[k8s:children]</span><br><span class="line">master</span><br><span class="line">node</span><br><span class="line"></span><br><span class="line">[newnode]</span><br><span class="line">#192.168.31.91 node_name=k8s-node3</span><br></pre></td></tr></table></figure>
<h4 id="3-2、全局参数配置"><a href="#3-2、全局参数配置" class="headerlink" title="3.2、全局参数配置"></a>3.2、全局参数配置</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-ansible1 ansible-install-k8s-master]# cat group_vars/all.yml</span><br><span class="line"># 安装目录</span><br><span class="line">software_dir: &apos;/root/binary_pkg&apos;</span><br><span class="line">k8s_work_dir: &apos;/opt/kubernetes&apos;</span><br><span class="line">etcd_work_dir: &apos;/opt/etcd&apos;</span><br><span class="line">tmp_dir: &apos;/tmp/k8s&apos;</span><br><span class="line"></span><br><span class="line"># 集群网络</span><br><span class="line">service_cidr: &apos;10.0.0.0/24&apos;</span><br><span class="line">cluster_dns: &apos;10.0.0.2&apos;   # 与roles/addons/files/coredns.yaml中IP一致</span><br><span class="line">pod_cidr: &apos;10.244.0.0/16&apos; # 与roles/addons/files/kube-flannel.yaml中网段一致</span><br><span class="line">service_nodeport_range: &apos;30000-32767&apos;</span><br><span class="line">cluster_domain: &apos;cluster.local&apos;</span><br><span class="line"></span><br><span class="line"># 高可用，如果部署单Master，该项忽略</span><br><span class="line">vip: &apos;192.168.171.88&apos;</span><br><span class="line">nic: &apos;ens33&apos;</span><br><span class="line"></span><br><span class="line"># 自签证书可信任IP列表，为方便扩展，可添加多个预留IP</span><br><span class="line">cert_hosts:</span><br><span class="line">  # 包含所有LB、VIP、Master IP和service_cidr的第一个IP（多多益善，可以多余出来几个后期扩展用）</span><br><span class="line">  k8s:</span><br><span class="line">    - 10.0.0.1</span><br><span class="line">    - 192.168.171.11</span><br><span class="line">    - 192.168.171.12</span><br><span class="line">    - 192.168.171.13</span><br><span class="line">    - 192.168.171.14</span><br><span class="line">    - 192.168.171.15</span><br><span class="line">    - 192.168.171.16</span><br><span class="line">    - 192.168.171.17</span><br><span class="line">    - 192.168.171.18</span><br><span class="line">    - 192.168.171.19</span><br><span class="line">    - 192.168.171.10</span><br><span class="line">    - 192.168.171.21</span><br><span class="line">    - 192.168.171.88</span><br><span class="line">  # 包含所有etcd节点IP</span><br><span class="line">  etcd:</span><br><span class="line">    - 192.168.171.11</span><br><span class="line">    - 192.168.171.12</span><br><span class="line">    - 192.168.171.13</span><br></pre></td></tr></table></figure>
<h4 id="3-3、准备部署"><a href="#3-3、准备部署" class="headerlink" title="3.3、准备部署"></a>3.3、准备部署</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">多Master版：</span><br><span class="line"></span><br><span class="line">ansible-playbook -i hosts multi-master-deploy.yml -uroot -k</span><br></pre></td></tr></table></figure>
<h4 id="3-4、输出历史（重点是结果）"><a href="#3-4、输出历史（重点是结果）" class="headerlink" title="3.4、输出历史（重点是结果）"></a>3.4、输出历史（重点是结果）</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">省略...</span><br></pre></td></tr></table></figure>
<h4 id="3-5、测试"><a href="#3-5、测试" class="headerlink" title="3.5、测试"></a>3.5、测试</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@k8s-ansible1 ~]# kubectl get node</span><br><span class="line">NAME          STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s-master1   Ready    &lt;none&gt;   85s   v1.16.0</span><br><span class="line">k8s-master2   Ready    &lt;none&gt;   85s   v1.16.0</span><br><span class="line">k8s-node1     Ready    &lt;none&gt;   85s   v1.16.0</span><br><span class="line">k8s-node2     Ready    &lt;none&gt;   85s   v1.16.0</span><br><span class="line"></span><br><span class="line">[root@k8s-ansible1 ~]# kubectl get po,svc --all-namespaces</span><br><span class="line">NAMESPACE              NAME                                             READY   STATUS    RESTARTS   AGE</span><br><span class="line">ingress-nginx          pod/nginx-ingress-controller-92b8v               1/1     Running   0          90s</span><br><span class="line">ingress-nginx          pod/nginx-ingress-controller-dfkp5               1/1     Running   0          90s</span><br><span class="line">ingress-nginx          pod/nginx-ingress-controller-hckvr               1/1     Running   0          91s</span><br><span class="line">ingress-nginx          pod/nginx-ingress-controller-qckdd               1/1     Running   0          90s</span><br><span class="line">kube-system            pod/coredns-6d8cfdd59d-lsdps                     1/1     Running   0          117s</span><br><span class="line">kube-system            pod/kube-flannel-ds-amd64-2mc74                  1/1     Running   1          100s</span><br><span class="line">kube-system            pod/kube-flannel-ds-amd64-4hqq7                  1/1     Running   0          101s</span><br><span class="line">kube-system            pod/kube-flannel-ds-amd64-dgzrb                  1/1     Running   0          100s</span><br><span class="line">kube-system            pod/kube-flannel-ds-amd64-zjtpq                  1/1     Running   0          100s</span><br><span class="line">kubernetes-dashboard   pod/dashboard-metrics-scraper-566cddb686-9xh7b   1/1     Running   0          116s</span><br><span class="line">kubernetes-dashboard   pod/kubernetes-dashboard-c4bc5bd44-4f45q         1/1     Running   0          116s</span><br><span class="line"></span><br><span class="line">NAMESPACE              NAME                                TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)          AGE</span><br><span class="line">default                service/kubernetes                  ClusterIP   10.0.0.1     &lt;none&gt;        443/TCP          5m40s</span><br><span class="line">ingress-nginx          service/ingress-nginx               ClusterIP   10.0.0.170   &lt;none&gt;        80/TCP,443/TCP   117s</span><br><span class="line">kube-system            service/kube-dns                    ClusterIP   10.0.0.2     &lt;none&gt;        53/UDP,53/TCP    117s</span><br><span class="line">kubernetes-dashboard   service/dashboard-metrics-scraper   ClusterIP   10.0.0.172   &lt;none&gt;        8000/TCP         116s</span><br><span class="line">kubernetes-dashboard   service/kubernetes-dashboard        NodePort    10.0.0.57    &lt;none&gt;        443:30001/TCP    116s</span><br><span class="line">[root@k8s-ansible1 ~]# kubectl get po,svc --all-namespaces -o wide</span><br><span class="line">NAMESPACE              NAME                                             READY   STATUS    RESTARTS   AGE    IP               NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">ingress-nginx          pod/nginx-ingress-controller-92b8v               1/1     Running   0          96s    192.168.171.11   k8s-master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">ingress-nginx          pod/nginx-ingress-controller-dfkp5               1/1     Running   0          96s    192.168.171.12   k8s-master2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">ingress-nginx          pod/nginx-ingress-controller-hckvr               1/1     Running   0          97s    192.168.171.13   k8s-node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">ingress-nginx          pod/nginx-ingress-controller-qckdd               1/1     Running   0          96s    192.168.171.14   k8s-node2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system            pod/coredns-6d8cfdd59d-lsdps                     1/1     Running   0          2m3s   10.244.1.2       k8s-master2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system            pod/kube-flannel-ds-amd64-2mc74                  1/1     Running   1          106s   192.168.171.12   k8s-master2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system            pod/kube-flannel-ds-amd64-4hqq7                  1/1     Running   0          107s   192.168.171.13   k8s-node1     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system            pod/kube-flannel-ds-amd64-dgzrb                  1/1     Running   0          106s   192.168.171.14   k8s-node2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system            pod/kube-flannel-ds-amd64-zjtpq                  1/1     Running   0          106s   192.168.171.11   k8s-master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kubernetes-dashboard   pod/dashboard-metrics-scraper-566cddb686-9xh7b   1/1     Running   0          2m2s   10.244.2.2       k8s-master1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kubernetes-dashboard   pod/kubernetes-dashboard-c4bc5bd44-4f45q         1/1     Running   0          2m2s   10.244.3.2       k8s-node2     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">NAMESPACE              NAME                                TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)          AGE     SELECTOR</span><br><span class="line">default                service/kubernetes                  ClusterIP   10.0.0.1     &lt;none&gt;        443/TCP          5m46s   &lt;none&gt;</span><br><span class="line">ingress-nginx          service/ingress-nginx               ClusterIP   10.0.0.170   &lt;none&gt;        80/TCP,443/TCP   2m3s    app.kubernetes.io/name=ingress-nginx,app.kubernetes.io/part-of=ingress-nginx</span><br><span class="line">kube-system            service/kube-dns                    ClusterIP   10.0.0.2     &lt;none&gt;        53/UDP,53/TCP    2m3s    k8s-app=kube-dns</span><br><span class="line">kubernetes-dashboard   service/dashboard-metrics-scraper   ClusterIP   10.0.0.172   &lt;none&gt;        8000/TCP         2m2s    k8s-app=dashboard-metrics-scraper</span><br><span class="line">kubernetes-dashboard   service/kubernetes-dashboard        NodePort    10.0.0.57    &lt;none&gt;        443:30001/TCP    2m2s    k8s-app=kubernetes-dashboard</span><br><span class="line"></span><br><span class="line">### 检查高可用的两台机器：</span><br><span class="line"></span><br><span class="line">[root@k8s-ansible5 ~]# ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: ens33: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:85:37:e0 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.171.15/24 brd 192.168.171.255 scope global noprefixroute ens33</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.171.88/24 scope global secondary ens33     ##虚拟VIP</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::d20b:b903:7edd:b18b/64 scope link tentative noprefixroute dadfailed</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::5d9e:cf1f:ea7f:801f/64 scope link tentative noprefixroute dadfailed</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::5c0:8885:2874:a77b/64 scope link tentative noprefixroute dadfailed</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[root@k8s-ansible5 ~]# ps aux | grep nginx</span><br><span class="line">root       7895  0.0  0.0  46356  1168 ?        Ss   22:57   0:00 nginx: master process /usr/sbin/nginx -c /etc/nginx/nginx.conf</span><br><span class="line">nginx      7896  0.1  0.1  47184  2308 ?        S    22:57   0:00 nginx: worker process</span><br><span class="line">nginx      7897  0.0  0.1  46780  1980 ?        S    22:57   0:00 nginx: worker process</span><br><span class="line">nginx      7898  0.0  0.1  46924  2216 ?        S    22:57   0:00 nginx: worker process</span><br><span class="line">nginx      7899  0.0  0.1  46876  2220 ?        S    22:57   0:00 nginx: worker process</span><br><span class="line">root      11331  0.0  0.0 112728   988 pts/0    S+   23:07   0:00 grep --color=auto nginx</span><br><span class="line">[root@k8s-ansible5 ~]# ps aux | grep keepalived</span><br><span class="line">root       7975  0.0  0.0 122884  1404 ?        Ss   22:57   0:00 /usr/sbin/keepalived -D</span><br><span class="line">root       7976  0.0  0.1 133844  3336 ?        S    22:57   0:00 /usr/sbin/keepalived -D</span><br><span class="line">root       7977  0.0  0.1 133784  2892 ?        S    22:57   0:00 /usr/sbin/keepalived -D</span><br><span class="line">root      11369  0.0  0.0 112724   992 pts/0    R+   23:07   0:00 grep --color=auto keepalived</span><br></pre></td></tr></table></figure>
<p><img src="http://myimage.okay686.cn/okay686cn/20191204/7GzoI4FprwXv.png?imageslim" srcset="/img/loading.gif" alt="mark"></p>
<hr>

            <hr>
          </div>
          <br>
          <div>
            <p>
            
              <span>
                <i class="iconfont icon-inbox"></i>
                
                  <a class="hover-with-bg" href="/categories/K8s">K8s</a>
                  &nbsp;
                
              </span>&nbsp;&nbsp;
            
            
              <span>
                <i class="iconfont icon-tag"></i>
                
                  <a class="hover-with-bg" href="/tags/Kubernets">Kubernets</a>
                
                  <a class="hover-with-bg" href="/tags/K8S">K8S</a>
                
              </span>
            
            </p>
            
              <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" rel="nofollow noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
            
          </div>
        </div>
      </div>
    </div>
    <div class="d-none d-lg-block col-lg-2 toc-container">
      
  <div id="toc">
    <p class="h4"><i class="far fa-list-alt"></i>&nbsp;目录</p>
    <div id="tocbot"></div>
  </div>

    </div>
  </div>
</div>

<!-- custom -->


<!-- Comments -->
<div class="col-lg-7 mx-auto nopadding-md">
  <div class="container comments mx-auto" id="comments">
    
  </div>
</div>

    
  </main>

  
    <a class="z-depth-1" id="scroll-top-button" href="#" role="button">
      <i class="fa fa-chevron-up scroll-top-arrow" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  <footer class="mt-5">
  <div class="text-center py-3">
    <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><b>Hexo</b></a>
    <i class="iconfont icon-love"></i>
    <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"> <b>Fluid</b></a>
    <br>

    
  
    <!-- 不蒜子统计PV -->
    
    &nbsp;<span id="busuanzi_container_site_pv">总访问量 
          <span id="busuanzi_value_site_pv"></span> 次</span>&nbsp;
  
  
    <!-- 不蒜子统计UV -->
    
    &nbsp;<span id="busuanzi_container_site_uv">总访客数 
            <span id="busuanzi_value_site_uv"></span> 人</span>&nbsp;
  
  <br>



    
  <!-- 备案信息 -->
  <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">苏ICP备16041225号-2</a>
  



    <!-- cnzz Analytics icon -->
    

  </div>
</footer>

<!-- SCRIPTS -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/popper/popper.min.js"></script>
<script src="/lib/bootstrap/js/bootstrap.min.js"></script>
<script src="/lib/mdbootstrap/js/mdb.min.js"></script>
<script src="/js/main.js"></script>


  <script src="/js/lazyload.js"></script>



  
    <script src="/lib/tocbot/tocbot.min.js"></script>
  
  <script src="/js/post.js"></script>



  <script src="/lib/smooth-scroll/smooth-scroll.min.js"></script>



  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<!-- Plugins -->


  

  

  

  

  <!-- cnzz Analytics -->
  



  <script src="/lib/prettify/prettify.min.js"></script>
  <script>
    $(document).ready(function () {
      $('pre').addClass('prettyprint  ');
      prettyPrint();
    })
  </script>



  <script src="/lib/typed/typed.min.js"></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "ansible自动化部署kubernetes-1.16&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 50,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script src="/lib/anchor/anchor.min.js"></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "false",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script src="/js/local-search.js"></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      getSearchFile(path);
      this.onclick = null
    }
  </script>



  <script src="/lib/fancybox/jquery.fancybox.min.js"></script>
  <script>
    $("#post img:not(.no-zoom img, img[no-zoom])").each(
      function () {
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "images");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      }
    );
  </script>





  
  
    <script>
      !function (e, t, a) {
        function r() {
          for (var e = 0; e < s.length; e++) s[e].alpha <= 0 ? (t.body.removeChild(s[e].el), s.splice(e, 1)) : (s[e].y--, s[e].scale += .004, s[e].alpha -= .013, s[e].el.style.cssText = "left:" + s[e].x + "px;top:" + s[e].y + "px;opacity:" + s[e].alpha + ";transform:scale(" + s[e].scale + "," + s[e].scale + ") rotate(45deg);background:" + s[e].color + ";z-index:99999");
          requestAnimationFrame(r)
        }

        function n() {
          var t = "function" == typeof e.onclick && e.onclick;
          e.onclick = function (e) {
            t && t(), o(e)
          }
        }

        function o(e) {
          var a = t.createElement("div");
          a.className = "heart", s.push({
            el: a,
            x: e.clientX - 5,
            y: e.clientY - 5,
            scale: 1,
            alpha: 1,
            color: c()
          }), t.body.appendChild(a)
        }

        function i(e) {
          var a = t.createElement("style");
          a.type = "text/css";
          try {
            a.appendChild(t.createTextNode(e))
          } catch (t) {
            a.styleSheet.cssText = e
          }
          t.getElementsByTagName("head")[0].appendChild(a)
        }

        function c() {
          return "rgb(" + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + "," + ~~(255 * Math.random()) + ")"
        }

        var s = [];
        e.requestAnimationFrame = e.requestAnimationFrame || e.webkitRequestAnimationFrame || e.mozRequestAnimationFrame || e.oRequestAnimationFrame || e.msRequestAnimationFrame || function (e) {
          setTimeout(e, 1e3 / 60)
        }, i(".heart{width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: fixed;}.heart:after{top: -5px;}.heart:before{left: -5px;}"), n(), r()
      }(window, document);
    </script>
  







</body>
</html>
